<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levegőminőség Térkép</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Supabase JavaScript kliens -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        #error-message { display: none; color: red; text-align: center; padding: 10px; background: #ffe6e6; position: absolute; top: 0; left: 0; right: 0; z-index: 1000; }
        #loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div id="error-message"></div>
    <div id="loading">Térkép betöltése...</div>
    <div id="map"></div>
    <script>
        // Hibakezelő függvény
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'block';
            errorDiv.textContent = message;
            console.error(message);
            document.getElementById('loading').style.display = 'none';
        }

        // Betöltés jelző
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Kezdeti adatok lekérése
        async function fetchInitialData(supabase) {
            const url = `${SUPABASE_URL}/rest/v1/air_quality?select=id,timestamp,latitude:st_y(location:geometry),longitude:st_x(location:geometry),pm1_0,pm2_5,pm4_0,pm10_0,humidity,temperature,voc,nox,co2`;
            try {
                console.log('Kezdeti adatok lekérése:', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'apikey': SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP hiba: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Kezdeti adatok betöltve:', data);
                return data;
            } catch (error) {
                showError('Hiba az adatok lekérésekor: ' + error.message + '. Lehetséges okok: CORS probléma, hibás Supabase URL/kulcs, vagy RLS korlátozás.');
                return [];
            }
        }

        // Marker hozzáadása a térképhez
        function addMarker(map, point) {
            if (!point.latitude || !point.longitude) {
                console.warn('Érvénytelen koordináták:', point);
                return;
            }
            try {
                const marker = L.marker([point.latitude, point.longitude]).addTo(map);
                marker.bindPopup(`
                    <b>Mérés</b><br>
                    Idő: ${point.timestamp || 'N/A'}<br>
                    PM1.0: ${point.pm1_0 || 'N/A'}<br>
                    PM2.5: ${point.pm2_5 || 'N/A'}<br>
                    PM4.0: ${point.pm4_0 || 'N/A'}<br>
                    PM10.0: ${point.pm10_0 || 'N/A'}<br>
                    Páratartalom: ${point.humidity || 'N/A'}%<br>
                    Hőmérséklet: ${point.temperature || 'N/A'}°C<br>
                    VOC: ${point.voc || 'N/A'}<br>
                    NOX: ${point.nox || 'N/A'}<br>
                    CO2: ${point.co2 || 'N/A'}
                `);
                console.log('Marker hozzáadva:', point.latitude, point.longitude);
            } catch (error) {
                console.error('Hiba a marker hozzáadásakor:', error);
            }
        }

        // Fő inicializáló függvény
        async function init() {
            // Supabase kliens inicializálása
            const SUPABASE_URL = 'https://yuamroqhxflusxerwp.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzE1MDYwMzM2LCJleHAiOjIwMzAzMjYzMzZ9.XVcJ9._eyjPc3m0jJdxBhYmFzZIsInJ';
            let supabase;
            try {
                if (typeof Supabase === 'undefined') {
                    throw new Error('A Supabase JS könyvtár nem töltődött be. Ellenőrizd a CDN URL-t: https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js');
                }
                supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase kliens sikeresen inicializálva');
            } catch (error) {
                showError('Hiba a Supabase kliens inicializálásakor: ' + error.message);
                return;
            }

            // Térkép inicializálása
            let map;
            try {
                map = L.map('map').setView([47.4979, 19.0402], 10); // Budapest
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                console.log('Leaflet térkép sikeresen inicializálva');
            } catch (error) {
                showError('Hiba a térkép inicializálásakor: ' + error.message);
                return;
            }

            // Kezdeti adatok megjelenítése
            const airQualityData = await fetchInitialData(supabase);
            airQualityData.forEach(point => addMarker(map, point));
            if (airQualityData.length === 0) {
                showError('Nincsenek elérhető adatok az air_quality táblában. Ellenőrizd, hogy a tábla tartalmaz-e adatokat, és hogy a SELECT jogosultság engedélyezve van-e.');
            }
            hideLoading();

            // Valós idejű frissítések
            let channel;
            try {
                channel = supabase
                    .channel('air-quality-changes')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'air_quality' }, 
                        payload => {
                            console.log('Új adat érkezett a Realtime csatornán:', payload);
                            const point = payload.new;
                            // Külön REST hívás az ST_X/ST_Y miatt
                            fetch(`${SUPABASE_URL}/rest/v1/air_quality?id=eq.${point.id}&select=id,timestamp,latitude:st_y(location:geometry),longitude:st_x(location:geometry),pm1_0,pm2_5,pm4_0,pm10_0,humidity,temperature,voc,nox,co2`, {
                                headers: {
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'apikey': SUPABASE_KEY,
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP hiba: ${response.status} ${response.statusText}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.length > 0) {
                                    addMarker(map, data[0]);
                                    console.log('Új marker hozzáadva Realtime esemény alapján:', data[0]);
                                } else {
                                    console.warn('Nincs új adat a REST hívásban:', point.id);
                                }
                            })
                            .catch(error => console.error('Hiba az új adat lekérésekor:', error));
                        }
                    )
                    .subscribe((status) => {
                        console.log('Realtime csatorna állapota:', status);
                        if (status === 'SUBSCRIBED') {
                            console.log('Sikeresen feliratkozva a Realtime csatornára');
                        } else if (status === 'CLOSED' || status === 'TIMED_OUT') {
                            showError('Realtime kapcsolat megszakadt. Kérjük, frissítse az oldalt.');
                        }
                    });
            } catch (error) {
                showError('Hiba a Realtime csatorna inicializálásakor: ' + error.message + '. Ellenőrizd, hogy a Realtime replikáció engedélyezve van-e az air_quality táblára.');
            }

            // Tisztítás az oldal elhagyásakor
            window.addEventListener('unload', () => {
                if (channel) {
                    supabase.removeChannel(channel);
                    console.log('Realtime csatorna leállítva');
                }
            });
        }

        // Várjuk meg, amíg a Supabase szkript betöltődik
        function waitForSupabase() {
            if (typeof Supabase !== 'undefined') {
                console.log('Supabase könyvtár betöltve, inicializálás indítása...');
                init();
            } else {
                console.log('Várakozás a Supabase könyvtár betöltésére...');
                setTimeout(waitForSupabase, 100); // Próbáljuk újra 100ms múlva
            }
        }

        // Indítás
        waitForSupabase();
    </script>
</body>
</html>