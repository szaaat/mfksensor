<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hőtérkép Elemzés - MFKSensor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://cdn.tailwindcss.com/3.4.0"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        #map { height: 70vh; width: 100%; }
        #loading-spinner {
            display: none; margin-left: 15px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lang-btn {
          padding: 2px 10px; border: 1px solid white; border-radius: 4px;
          background: transparent; color: white; cursor: pointer; transition: all 0.3s;
        }
        .lang-btn.active { background: white; color: green; font-weight: bold; }
        .lang-btn:hover:not(.active) { background: rgba(255,255,255,0.2); }
        
        .info.legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.4;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 4px;
            text-align: center;
        }
        .legend-gradient {
            width: 25px;
            height: 120px;
            border: 1px solid #ccc;
        }
        .legend-labels {
            position: relative;
            height: 120px;
            width: 25px;
            float: right;
            margin-left: 4px;
        }
        .legend-labels span {
            position: absolute;
            left: 4px;
            font-size: 10px;
            color: #333;
        }
        .legend-labels .max { top: 0; }
        .legend-labels .mid { top: 50%; transform: translateY(-50%); }
        .legend-labels .min { bottom: 0; }
        
        .controls button.active {
            background-color: #16a34a;
            color: white;
            font-weight: bold;
        }
        #about-text {
            text-align: justify;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 font-sans min-h-screen flex flex-col">

<header class="bg-green-700 text-white text-center py-4 shadow-lg relative">
    <div class="absolute top-3 right-3 flex space-x-2">
      <button id="lang-hu" class="lang-btn active" data-lang="hu">HU</button>
      <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
    </div>
    <h1 id="main-title" class="text-lg md:text-2xl font-extrabold tracking-tight mobile-title">Hőtérkép Elemzés</h1>
</header>

<nav class="bg-green-600 text-white py-2 shadow-md mobile-nav">
    <div class="container mx-auto px-3 flex flex-wrap justify-center gap-x-3 gap-y-1 mobile-nav">
      <a href="index.html" id="nav-home" class="text-sm font-semibold hover:text-green-200 transition-colors mobile-text">Kezdőlap</a>
      <a href="map.html" id="nav-map" class="text-sm font-semibold hover:text-green-200 transition-colors mobile-text">Térkép</a>
      <a href="heatmap.html" id="nav-heatmap" class="text-sm font-semibold hover:text-green-200 transition-colors mobile-text underline decoration-2">Hőtérkép</a>
      <a href="correlation.html" id="nav-correlation" class="text-sm font-semibold hover:text-green-200 transition-colors mobile-text">Korreláció</a>
      <a href="about.html" id="nav-about" class="text-sm font-semibold hover:text-green-200 transition-colors mobile-text">Rólunk</a>
    </div>
</nav>

<div class="controls text-center p-3 bg-gray-100 shadow-sm">
    <label for="period-select" id="period-label" class="font-semibold text-gray-700 mobile-text">Válassz időszakot:</label>
    <select id="period-select" class="mx-1 p-1 rounded border border-gray-300 mobile-text">
        <option id="period-all" value="annual">Összes (teljes átlag)</option>
        <option id="period-winter" value="winter">Tél (Dec, Jan, Feb)</option>
        <option id="period-spring" value="spring">Tavasz (Már, Ápr, Máj)</option>
        <option id="period-summer" value="summer">Nyár (Jún, Júl, Aug)</option>
        <option id="period-autumn" value="autumn">Ősz (Szep, Okt, Nov)</option>
    </select>
    
    <label for="metric-select" id="metric-label" class="ml-2 font-semibold text-gray-700 mobile-text">Válassz adatot:</label>
    <select id="metric-select" class="mx-1 p-1 rounded border border-gray-300 mobile-text">
        <option value="pm2_5">PM2.5</option>
        <option value="pm25_bg">PM2.5 Háttér</option>
        <option value="pm25_diff">PM2.5 Különbség</option>
        <option value="co2">CO2</option>
        <option value="co2_bg">CO2 Háttér</option>
        <option value="co2_diff">CO2 Különbség</option>
        <option value="altitude">Magasság</option>
        <option value="voc">VOC Index</option>
        <option value="nox">NOx Index</option>
        <option value="temperature">Hőmérséklet</option>
        <option value="humidity">Páratartalom</option>
    </select>

    <div class="mt-2 flex flex-wrap justify-center gap-2">
        <label for="min-value" class="font-semibold text-gray-700 mobile-text">Skála Min:</label>
        <input type="number" id="min-value" class="mx-1 p-1 rounded border border-gray-300 w-16 mobile-text">
        
        <label for="max-value" class="font-semibold text-gray-700 mobile-text">Skála Max:</label>
        <input type="number" id="max-value" class="mx-1 p-1 rounded border border-gray-300 w-16 mobile-text">
        
        <button id="update-scale-btn" class="ml-1 p-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm mobile-text">Frissít</button>
        <button id="polluted-btn" class="ml-2 p-1 rounded bg-gray-300 text-sm mobile-text">Szennyezett</button>
        <button id="all-btn" class="ml-1 p-1 rounded bg-gray-300 text-sm mobile-text">Teljes adatsor</button>
        
        <div id="loading-spinner"></div>
    </div>
</div>

<div id="map" class="flex-grow"></div>

<div class="container mx-auto px-4 py-4 mt-4 bg-white shadow-lg rounded-lg mobile-container">
    <h2 id="about-title" class="text-lg font-bold text-green-700 mb-3 mobile-title">Az oldal működése</h2>
    <p id="about-text" class="text-gray-700 leading-relaxed mobile-text">
        Ez az oldal mobil szenzorok által gyűjtött, aggregált levegőminőségi adatokat (pl. PM2.5, CO2, NOx) jelenít meg egy interaktív hőtérképen. Az adatok rácsra vannak átlagolva, hogy bemutassák a területi eloszlást. A vezérlőkkel kiválaszthatja a vizsgált időszakot (szezonális vagy éves átlag) és a mért adat típusát. A 'Skála Min' és 'Skála Max' mezőkkel finomhangolhatja a vizuális skálát, hogy kiemelje az Ön számára fontos értéktartományokat.
    </p>
</div>

<footer class="bg-green-700 text-white text-center py-2 mt-auto">
    <p id="footer-text" class="text-sm mobile-text">© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium projekt támogatásával valósul meg.</p>
    <p id="disclaimer-text" class="text-sm text-red-600 mt-1 font-semibold mobile-text">A mérési adatok nem hitelesítettek.</p>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = 'https://yuamroqhxrflusxeyylp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NjA2ODgsImV4cCI6MjA2MTQzNjY4OH0.GOzgzWLxQnT6YzS8z2D4OKrsHkBnS55L7oRTMsEKs8U';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const METRIC_CONFIG = {
        'pm1_0':       { max: 20, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm2_5':       { max: 20, min: 5, unit: 'µg/m³', gradient: { 0.1: 'blue', 0.4: 'green', 0.8: 'yellow', 1: 'red' } }, 
        'pm25_bg':     { max: 15, min: 0, unit: 'µg/m³', gradient: { 0.1: 'blue', 0.4: 'green', 0.8: 'yellow', 1: 'orange' } },
        'pm25_diff':   { max: 15, min: 0, unit: 'µg/m³', gradient: { 0.0: 'white', 0.2: 'yellow', 0.5: 'orange', 1: 'red' } },
        'pm4_0':       { max: 30, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm10_0':      { max: 40, min: 10, unit: 'µg/m³', gradient: { 0.1: 'blue', 0.4: 'green', 0.8: 'yellow', 1: 'red' } }, 
        'temperature': { 
            max: 35, min: 0, unit: '°C', 
            gradient: { 0.0: '#440154', 0.5: '#f06e12', 1: '#fde725' } 
        },
        'humidity': {
            max: 100, min: 0, unit: '%',
            gradient: { 0.0: '#FFFFFF', 0.5: '#00FFFF', 1: '#0000A0' } 
        },
        'co2': { 
            max: 1000, min: 350, unit: 'ppm', 
            gradient: { 0.1: 'blue', 0.4: 'green', 0.7: 'yellow', 1: 'red' } 
        },
        'co2_bg': { 
            max: 500, min: 350, unit: 'ppm', 
            gradient: { 0.1: 'cyan', 0.5: 'blue', 1: 'purple' } 
        },
        'co2_diff': { 
            max: 300, min: 0, unit: 'ppm', 
            gradient: { 0.0: 'white', 0.2: 'yellow', 0.5: 'orange', 1: 'red' } 
        },
        'altitude': { 
            max: 1000, min: 0, unit: 'm', 
            gradient: { 0.0: 'green', 0.3: 'yellow', 0.6: 'orange', 1: 'brown' } 
        },
        'voc': { 
            max: 120, min: 100, unit: 'index',
            gradient: { 0.1: 'green', 0.5: 'yellow', 1: 'red' }
        },
        'nox': { 
            max: 3, min: 1, unit: 'index',
            gradient: { 0.1: 'green', 0.5: 'yellow', 1: 'red' } 
        }
    };
    const DEFAULT_CONFIG = { max: 100, min: 0, unit: '', gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' } };

    const map = L.map('map').setView([47.95, 20.55], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let heatLayer = null;
    let legendControl = null;
    const loadingSpinner = document.getElementById('loading-spinner');
    const periodSelect = document.getElementById('period-select');
    const metricSelect = document.getElementById('metric-select');
    const minInput = document.getElementById('min-value');
    const maxInput = document.getElementById('max-value');
    const updateScaleBtn = document.getElementById('update-scale-btn');
    
    const pollutedBtn = document.getElementById('polluted-btn');
    const allBtn = document.getElementById('all-btn');
    let currentAnalysisMode = 'polluted';

    function createGradientCSS(gradient) {
        const stops = Object.entries(gradient).sort(([a], [b]) => a - b);
        const cssStops = stops.map(([stop, color]) => `${color} ${stop * 100}%`);
        return `linear-gradient(to top, ${cssStops.join(', ')})`;
    }

    async function updateHeatmap() {
        const period = periodSelect.value;
        const metric = metricSelect.value;
        loadingSpinner.style.display = 'inline-block';
        
        let config = METRIC_CONFIG[metric] || DEFAULT_CONFIG;

        const userMin = parseFloat(minInput.value);
        const userMax = parseFloat(maxInput.value);

        if (!isNaN(userMin) && !isNaN(userMax) && userMin < userMax) {
            config = { 
                ...config,
                min: userMin, 
                max: userMax 
            };
        } else {
            minInput.value = config.min;
            maxInput.value = config.max;
        }
        
        try {
            const { data, error } = await supabaseClient.rpc('get_heatmap_data', {
                period_filter: period,
                metric: metric,
                grid_size: 0.001,
                analysis_mode: currentAnalysisMode
            });

            if (error) throw error;
            if (heatLayer) map.removeLayer(heatLayer);
            if (legendControl) map.removeControl(legendControl); 

            if (data.length === 0) {
                console.log("Nincs adat erre a szűrésre.");
                return;
            }

            const heatData = data.map(p => [p.lat, p.lon, p.intensity]);
            
            heatLayer = L.heatLayer(heatData, {
                radius: 12,
                blur: 5,
                maxZoom: 18,
                max: config.max,
                gradient: config.gradient
            }).addTo(map);

            legendControl = L.control({position: 'bottomright'});
            legendControl.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const gradientCSS = createGradientCSS(config.gradient);
                const currentLang = localStorage.getItem('language') || 'hu';
                const title = translations[currentLang].legendTitle + ` (${config.unit})`;

                div.innerHTML = `
                    <div class="legend-title mobile-text">${title}</div>
                    <div style="display: flex;">
                        <div class="legend-gradient" style="background: ${gradientCSS};"></div>
                        <div class="legend-labels">
                            <span class="max mobile-text">${config.max}</span>
                            <span class="mid mobile-text">${((config.max + config.min) / 2).toPrecision(3)}</span>
                            <span class="min mobile-text">${config.min}</span>
                        </div>
                    </div>
                `;
                return div;
            };
            legendControl.addTo(map);

        } catch (error) {
            console.error('Hiba a hőtérkép adatok lekérése közben:', error.message);
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    periodSelect.addEventListener('change', updateHeatmap);
    metricSelect.addEventListener('change', () => {
        minInput.value = '';
        maxInput.value = '';
        updateHeatmap();
    });
    updateScaleBtn.addEventListener('click', updateHeatmap);
    
    const translations = {
      hu: {
        title: "Hőtérkép Elemzés - MFKSensor",
        mainTitle: "Hőtérkép Elemzés",
        navHome: "Kezdőlap",
        navMap: "Térkép",
        navHeatmap: "Hőtérkép", 
        navCorrelation: "Korreláció",
        navAbout: "Rólunk",
        periodLabel: "Válassz időszakot:",
        metricLabel: "Válassz adatot:",
        periodAll: "Összes (teljes átlag)",
        periodWinter: "Tél (Dec, Jan, Feb)",
        periodSpring: "Tavasz (Már, Ápr, Máj)",
        periodSummer: "Nyár (Jún, Júl, Aug)", 
        periodAutumn: "Ősz (Szep, Okt, Nov)",
        scaleMinLabel: "Skála Min:",
        scaleMaxLabel: "Skála Max:",
        updateScaleBtn: "Frissít",
        pollutedBtn: "Szennyezett",
        allBtn: "Teljes adatsor",
        legendTitle: "Jelmagyarázat",
        footer: "© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium projekt támogatásával valósul meg.",
        disclaimer: "A mérési adatok nem hitelesítettek.",
        aboutTitle: "Az oldal működése",
        aboutText: "Ez az oldal mobil szenzorok által gyűjtött, aggregált levegőminőségi adatokat (pl. PM2.5, CO2, NOx) jelenít meg egy interaktív hőtérképen. Az adatok rácsra vannak átlagolva, hogy bemutassák a területi eloszlást. A vezérlőkkel kiválaszthatja a vizsgált időszakot (szezonális vagy éves átlag) és a mért adat típusát. A 'Skála Min' és 'Skála Max' mezőkkel finomhangolhatja a vizuális skálát, hogy kiemelje az Ön számára fontos értéktartományokat."
      },
      en: {
        title: "Heatmap Analysis - MFKSensor", 
        mainTitle: "Heatmap Analysis",
        navHome: "Home",
        navMap: "Map",
        navHeatmap: "Heatmap",
        navCorrelation: "Correlation",
        navAbout: "About",
        periodLabel: "Select period:",
        metricLabel: "Select metric:", 
        periodAll: "All (total average)",
        periodWinter: "Winter (Dec, Jan, Feb)",
        periodSpring: "Spring (Mar, Apr, May)",
        periodSummer: "Summer (Jun, Jul, Aug)",
        periodAutumn: "Autumn (Sep, Oct, Nov)",
        scaleMinLabel: "Scale Min:",
        scaleMaxLabel: "Scale Max:", 
        updateScaleBtn: "Update",
        pollutedBtn: "Polluted",
        allBtn: "Full dataset",
        legendTitle: "Legend",
        footer: "© Realized with the support of the National Multidisciplinary Laboratory for Climate Change project.",
        disclaimer: "Measurement data is not verified.",
        aboutTitle: "How This Page Works",
        aboutText: "This page displays aggregated air quality data collected by mobile sensors (e.g., PM2.5, CO2, NOx) on an interactive heatmap. The data is averaged onto a grid to show spatial distribution. Using the controls, you can select the time period to examine (seasonal or annual average) and the type of measured data. The 'Scale Min' and 'Scale Max' fields allow you to fine-tune the visual scale to highlight value ranges important to you."
      }
    };

    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      applyLanguage(lang);
    }

    function applyLanguage(lang) {
      const langData = translations[lang];
      document.title = langData.title;
      document.getElementById('main-title').textContent = langData.mainTitle;
      
      // Navigáció
      document.getElementById('nav-home').textContent = langData.navHome;
      document.getElementById('nav-map').textContent = langData.navMap;
      document.getElementById('nav-heatmap').textContent = langData.navHeatmap;
      document.getElementById('nav-correlation').textContent = langData.navCorrelation;
      document.getElementById('nav-about').textContent = langData.navAbout;
      
      // Vezérlők
      document.getElementById('period-label').innerHTML = langData.periodLabel; 
      document.getElementById('metric-label').innerHTML = langData.metricLabel; 
      document.getElementById('period-all').textContent = langData.periodAll;
      document.getElementById('period-winter').textContent = langData.periodWinter;
      document.getElementById('period-spring').textContent = langData.periodSpring;
      document.getElementById('period-summer').textContent = langData.periodSummer;
      document.getElementById('period-autumn').textContent = langData.periodAutumn;
      
      // Skála és gombok
      document.querySelector('label[for="min-value"]').textContent = langData.scaleMinLabel;
      document.querySelector('label[for="max-value"]').textContent = langData.scaleMaxLabel;
      document.getElementById('update-scale-btn').textContent = langData.updateScaleBtn;
      document.getElementById('polluted-btn').textContent = langData.pollutedBtn;
      document.getElementById('all-btn').textContent = langData.allBtn;
      
      // Lábléc és leírás
      document.getElementById('footer-text').textContent = langData.footer;
      document.getElementById('disclaimer-text').textContent = langData.disclaimer;
      document.getElementById('about-title').textContent = langData.aboutTitle;
      document.getElementById('about-text').textContent = langData.aboutText;
      
      document.documentElement.lang = lang;
      
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // Metrika opciók fordítása
      const metricOptions = {
        'pm2_5': 'PM2.5',
        'pm25_bg': lang === 'hu' ? 'PM2.5 Háttér' : 'PM2.5 Background',
        'pm25_diff': lang === 'hu' ? 'PM2.5 Különbség' : 'PM2.5 Difference',
        'temperature': lang === 'hu' ? 'Hőmérséklet' : 'Temperature',
        'humidity': lang === 'hu' ? 'Páratartalom' : 'Humidity',
        'co2': 'CO₂',
        'co2_bg': lang === 'hu' ? 'CO₂ Háttér' : 'CO₂ Background',
        'co2_diff': lang === 'hu' ? 'CO₂ Különbség' : 'CO₂ Difference',
        'voc': lang === 'hu' ? 'VOC Index' : 'VOC Index',
        'nox': lang === 'hu' ? 'NOx Index' : 'NOx Index',
        'altitude': lang === 'hu' ? 'Magasság' : 'Altitude',
        'pm1_0': 'PM1.0',
        'pm4_0': 'PM4.0',
        'pm10_0': 'PM10.0'
      };
      
      const select = document.getElementById('metric-select');
      Array.from(select.options).forEach(opt => {
          if(metricOptions[opt.value]) opt.text = metricOptions[opt.value];
      });
    
      if (legendControl) {
          updateHeatmap(); 
      }
    }   
    
    function setAnalysisMode(mode) {
        currentAnalysisMode = mode;
        if (mode === 'polluted') {
            pollutedBtn.classList.add('active');
            allBtn.classList.remove('active');
        } else {
            pollutedBtn.classList.remove('active');
            allBtn.classList.add('active');
        }
        updateHeatmap();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedLang = localStorage.getItem('language') || 'hu';
      setLanguage(savedLang);

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setLanguage(btn.dataset.lang);
        });
      });

      pollutedBtn.addEventListener('click', () => setAnalysisMode('polluted'));
      allBtn.addEventListener('click', () => setAnalysisMode('all'));
      
      setAnalysisMode(currentAnalysisMode);
    });
</script>

</body>
</html>