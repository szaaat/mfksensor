<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szezonális Hőtérkép - MFKSensor</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #map { height: 75vh; width: 100%; }
        #loading-spinner {
            display: none; margin-left: 15px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lang-btn {
          padding: 2px 10px; border: 1px solid white; border-radius: 4px;
          background: transparent; color: white; cursor: pointer; transition: all 0.3s;
        }
        .lang-btn.active { background: white; color: green; font-weight: bold; }
        .lang-btn:hover:not(.active) { background: rgba(255,255,255,0.2); }
        
        /* ÚJ: Jelmagyarázat stílusa */
        .info.legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        .legend-gradient {
            width: 30px;
            height: 150px;
            border: 1px solid #ccc;
        }
        .legend-labels {
            position: relative;
            height: 150px;
            width: 30px;
            float: right;
            margin-left: 5px;
        }
        .legend-labels span {
            position: absolute;
            left: 5px;
            font-size: 12px;
            color: #333;
        }
        .legend-labels .max { top: 0; }
        .legend-labels .mid { top: 50%; transform: translateY(-50%); }
        .legend-labels .min { bottom: 0; }
        .controls button.active {
            background-color: #16a34a; /* Zöld */
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 font-sans min-h-screen flex flex-col">

<header class="bg-green-700 text-white text-center py-8 shadow-lg relative">
    <div class="absolute top-4 right-4 flex space-x-2">
      <button id="lang-hu" class="lang-btn active" data-lang="hu">HU</button>
      <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
    </div>
    <h1 id="main-title" class="text-2xl md:text-4xl font-extrabold tracking-tight">Hőtérkép Elemzés</h1>
</header>

<nav class="bg-green-600 text-white py-4 shadow-md">
    <div class="container mx-auto px-6 flex flex-wrap justify-center gap-x-8 gap-y-2">
      <a href="/mfksensor/" id="nav-home" class="text-lg font-semibold hover:text-green-200 transition-colors">Kezdőlap</a>
      <a href="/mfksensor/map.html" id="nav-map" class="text-lg font-semibold hover:text-green-200 transition-colors">PM2.5 Térkép</a>
      <a href="/mfksensor/map_co2.html" id="nav-map-co2" class="text-lg font-semibold hover:text-green-200 transition-colors">CO₂ Térkép</a>
      <a href="/mfksensor/heatmap.html" id="nav-heatmap" class="text-lg font-semibold hover:text-green-200 transition-colors underline decoration-2">Hőtérkép</a>
      <a href="/mfksensor/comparison.html" id="nav-comparison" class="text-lg font-semibold hover:text-green-200 transition-colors">Összehasonlítás</a>
      <a href="/mfksensor/correlation.html" id="nav-correlation" class="text-lg font-semibold hover:text-green-200 transition-colors">Korreláció</a>
      <a href="/mfksensor/about.html" id="nav-about" class="text-lg font-semibold hover:text-green-200 transition-colors">Rólunk</a>
    </div>
</nav>

<div class="controls text-center p-4 bg-gray-100 shadow-sm">
    <label for="period-select" id="period-label" class="font-semibold text-gray-700">Válassz időszakot:</label>
    <select id="period-select" class="mx-2 p-2 rounded border border-gray-300">
        <option id="period-all" value="annual">Összes (teljes átlag)</option>
        <option id="period-winter" value="winter">Tél (Dec, Jan, Feb)</option>
        <option id="period-spring" value="spring">Tavasz (Már, Ápr, Máj)</option>
        <option id="period-summer" value="summer">Nyár (Jún, Júl, Aug)</option>
        <option id="period-autumn" value="autumn">Ősz (Szep, Okt, Nov)</option>
    </select>
    <label for="metric-select" id="metric-label" class="ml-4 font-semibold text-gray-700">Válassz adatot:</label>
    <select id="metric-select" class="mx-2 p-2 rounded border border-gray-300">
        <option value="pm1_0">PM1.0</option>
        <option value="pm2_5">PM2.5</option>
        <option value="pm4_0">PM4.0</option>
        <option value="pm10_0">PM10.0</option>
        <option value="voc">VOC Index</option>
        <option value="nox">NOx Index</option>
        <option value="co2">CO2</option>
        <option value="temperature">Hőmérséklet</option>
        <option value="humidity">Páratartalom</option>

<div class="controls text-center p-4 bg-gray-100 shadow-sm">
    <label for="period-select" ...>...</label>
    <select id="period-select" ...>...</select>
    
    <label for="metric-select" ...>...</label>
    <select id="metric-select" ...>...</select>

    <label for="min-value" class="ml-4 font-semibold text-gray-700">Skála Min:</label>
    <input type="number" id="min-value" class="mx-1 p-2 rounded border border-gray-300 w-20">
    
    <label for="max-value" class="ml-2 font-semibold text-gray-700">Skála Max:</label>
    <input type="number" id="max-value" class="mx-1 p-2 rounded border border-gray-300 w-20">
    
    <button id="update-scale-btn" class="ml-2 p-2 bg-green-600 text-white rounded hover:bg-green-700">Frissít</button>
    <button id="polluted-btn" class="ml-4 p-2 rounded bg-gray-300">Szennyezett</button>
    <button id="all-btn" class="ml-2 p-2 rounded bg-gray-300">Teljes adatsor</button>
    <div id="loading-spinner"></div>
</div>       
        
    </select>
    <div id="loading-spinner"></div>
</div>

<div id="map" class="flex-grow"></div>

<div class="container mx-auto px-6 py-8 mt-8 bg-white shadow-lg rounded-lg">
    <h2 id="about-title" class="text-2xl font-bold text-green-700 mb-4">Az oldal működése</h2>
    <p id="about-text" class="text-gray-700 leading-relaxed">
        Ez az oldal mobil szenzorok által gyűjtött, aggregált levegőminőségi adatokat (pl. PM2.5, CO2, NOx) jelenít meg egy interaktív hőtérképen. Az adatok rácsra vannak átlagolva, hogy bemutassák a területi eloszlást. A vezérlőkkel kiválaszthatja a vizsgált időszakot (szezonális vagy éves átlag) és a mért adat típusát. A 'Skála Min' és 'Skála Max' mezőkkel finomhangolhatja a vizuális skálát, hogy kiemelje az Ön számára fontos értéktartományokat.
    </p>
</div>


<footer class="bg-green-700 text-white text-center py-4 mt-auto">
    <p id="footer-text" class="text-sm">© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium projekt támogatásával valósul meg.</p>
    <p id="disclaimer-text" class="text-sm text-red-600 mt-2 font-semibold">A mérési adatok nem hitelesítettek.</p>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = 'https://yuamroqhxrflusxeyylp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NjA2ODgsImV4cCI6MjA2MTQzNjY4OH0.GOzgzWLxQnT6YzS8z2D4OKrsHkBnS55L7oRTMsEKs8U';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // -----------------------------------------------------------------
    // 2. METRIKA KONFIG (▼▼▼ MÓDOSÍTVA ▼▼▼)
    // -----------------------------------------------------------------
    // Még alacsonyabb 'max' értékek és új színátmenet (kékkel kezdve)
    // Hozzáadva 'min' és 'unit' a jelmagyarázathoz
    // -----------------------------------------------------------------
    // 2. METRIKA KONFIG (Frissítve a 'nox' érzékenységgel)
    // -----------------------------------------------------------------
    // -----------------------------------------------------------------
    // 2. METRIKA KONFIG (Frissítve: Szuper-érzékeny NOx skála)
    // -----------------------------------------------------------------
    // -----------------------------------------------------------------
    // 2. METRIKA KONFIG (Frissítve: Éles NOx skála 1-nél)
    // -----------------------------------------------------------------
    // -----------------------------------------------------------------
    // 2. METRIKA KONFIG (Frissítve: Szuper-érzékeny skála)
    // -----------------------------------------------------------------
    const METRIC_CONFIG = {
        // PM, T, H, CO2 - Változatlan
        'pm1_0':       { max: 20, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm2_5':       { max: 20, min: 5, unit: 'µg/m³', gradient: { 0.1: 'blue', 0.4: 'green', 0.8: 'yellow', 1: 'red' } }, 
        'pm4_0':       { max: 30, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm10_0':      { max: 40, min: 10, unit: 'µg/m³', gradient: { 0.1: 'blue', 0.4: 'green', 0.8: 'yellow', 1: 'red' } }, 
        'temperature': { max: 35, min: 0, unit: '°C',  gradient: { 0.0: '#0000FF', 0.5: '#FFFF00', 1: '#FF0000' } },
        'humidity':    { max: 100, min: 0, unit: '%',   gradient: { 0.4: '#FFFF00', 0.7: '#00FFFF', 1: '#0000FF' } },
        'co2':         { max: 1200, min: 500, unit: 'ppm', gradient: { 0.1: 'blue', 0.4: 'green', 0.7: 'yellow', 1: 'red' } }, 

        // ▼▼▼ EZ A MÓDOSÍTOTT RÉSZ ▼▼▼
        'voc': { 
            max: 120, min: 100, unit: 'index', // Max: 120 (a 150 helyett)
            // A skála 100-nál (normál) kezdődik és 120-nál (extrém) végződik
            gradient: { 0.1: '#FFFF00', 0.5: '#FF9900', 1: '#FF0000' } 
        },
        'nox': { 
            max: 3, min: 1, unit: 'index', // Max: 3 (a 10 helyett)
            // A skála 1-nél (normál) kezdődik és 3-nál (extrém) végződik
            // A "dugó" (2-es érték) pont a narancs és sárga közé esik (0.5)
            gradient: { 0.1: '#FFFF00', 0.5: '#FF9900', 1: '#FF0000' } 
        }
        // ▲▲▲ MÓDOSÍTÁS VÉGE ▲▲▲
    };
    const DEFAULT_CONFIG = { max: 100, min: 0, unit: '', gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' } };

    const map = L.map('map').setView([47.95, 20.55], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let heatLayer = null;
    let legendControl = null; // ÚJ: Változó a jelmagyarázat tárolására
    const loadingSpinner = document.getElementById('loading-spinner');
    const periodSelect = document.getElementById('period-select');
    const metricSelect = document.getElementById('metric-select');
    const minInput = document.getElementById('min-value');
    const maxInput = document.getElementById('max-value');
    const updateScaleBtn = document.getElementById('update-scale-btn');
    
    const pollutedBtn = document.getElementById('polluted-btn');
    const allBtn = document.getElementById('all-btn');
    let currentAnalysisMode = 'polluted';

    // ÚJ: Helper függvény a CSS színátmenet generálásához
    function createGradientCSS(gradient) {
        const stops = Object.entries(gradient).sort(([a], [b]) => a - b);
        const cssStops = stops.map(([stop, color]) => `${color} ${stop * 100}%`);
        return `linear-gradient(to top, ${cssStops.join(', ')})`;
    }

    // -----------------------------------------------------------------
    // 4. ADATLEKÉRÉS (▼▼▼ MÓDOSÍTVA ▼▼▼)
    // -----------------------------------------------------------------
    async function updateHeatmap() {
        const period = periodSelect.value;
        const metric = metricSelect.value;
        loadingSpinner.style.display = 'inline-block';
        
        // 1. Alapértelmezett config betöltése
        // (Használj 'let'-et 'const' helyett, hogy felülírhassuk)
        let config = METRIC_CONFIG[metric] || DEFAULT_CONFIG;

        // 2. ÚJ: Felülírás a felhasználói bemenettel
        // Ellenőrizzük, hogy a mezőkben érvényes számok vannak-e
        const userMin = parseFloat(minInput.value);
        const userMax = parseFloat(maxInput.value);

        if (!isNaN(userMin) && !isNaN(userMax) && userMin < userMax) {
            // Lemásoljuk és felülírjuk a configot, hogy az eredeti METRIC_CONFIG ne sérüljön
            config = { 
                ...config, // Megtartja az eredeti 'unit'-ot és 'gradient'-et
                min: userMin, 
                max: userMax 
            };
        } else {
            // Ha a mezők üresek vagy érvénytelenek, töltsük fel őket az alapértelmezettekkel
            minInput.value = config.min;
            maxInput.value = config.max;
        }
        
        try {
            const { data, error } = await supabaseClient.rpc('get_heatmap_data', {
                period_filter: period,
                metric: metric,
                grid_size: 0.001,
                analysis_mode: currentAnalysisMode // <-- EZ AZ ÚJ PARAMÉTER!
            });

        try {
            const { data, error } = await supabaseClient.rpc('get_heatmap_data', {
                period_filter: period,
                metric: metric,
                grid_size: 0.001
            });

            if (error) throw error;
            if (heatLayer) map.removeLayer(heatLayer);
            
            // ÚJ: Jelmagyarázat eltávolítása
            if (legendControl) map.removeControl(legendControl);

            if (data.length === 0) {
                console.log("Nincs adat erre a szűrésre.");
                return;
            }

            const heatData = data.map(p => [p.lat, p.lon, p.intensity]);
            
            // ▼▼▼ MÓDOSÍTVA: Élesebb pontok (radius: 12, blur: 8) ▼▼▼
            heatLayer = L.heatLayer(heatData, {
                radius: 14,
                blur: 6,
                maxZoom: 18,
                max: config.max, // JAVÍTVA: A felhasználó által beállított maximum
                // A Leaflet.heat alapértelmezetten 0-t használ minimumnak, 
                // de a 'min' opciót is beállíthatod, ha a könyvtár támogatja 
                // (bár a legtöbb implementáció 0-tól skáláz a 'max'-ig)                    // FIX 1.0
                gradient: config.gradient
            }).addTo(map);

            // -----------------------------------------------------------------
            // 5. ÚJ: JELMAGYARÁZAT HOZZÁADÁSA
            // -----------------------------------------------------------------
            legendControl = L.control({position: 'bottomright'});
            legendControl.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const gradientCSS = createGradientCSS(config.gradient);
                const currentLang = localStorage.getItem('language') || 'hu';
                const title = translations[currentLang].legendTitle + ` (${config.unit})`;

                div.innerHTML = `
                    <div class="legend-title">${title}</div>
                    <div style="display: flex;">
                        <div class="legend-gradient" style="background: ${gradientCSS};"></div>
                        <div class="legend-labels">
                            <span class="max">${config.max}</span>
                            <span class="mid">${(config.max + config.min) / 2}</span>
                            <span class="min">${config.min}</span>
                        </div>
                    </div>
                `;
                return div;
            };
            legendControl.addTo(map);

        } catch (error) {
            console.error('Hiba a hőtérkép adatok lekérése közben:', error.message);
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    periodSelect.addEventListener('change', updateHeatmap);
    metricSelect.addEventListener('change', () => {
        // Amikor metrikát vált, töröljük az input mezőket,
        // hogy az updateHeatmap az új alapértékkel töltse fel őket.
        minInput.value = '';
        maxInput.value = '';
        updateHeatmap();
    });

    // ÚJ: A gomb eseménykezelője
    updateScaleBtn.addEventListener('click', updateHeatmap);
</script>

<script>
    const translations = {
      hu: {
        title: "Szezonális Hőtérkép - MFKSensor",
        mainTitle: "Hőtérkép Elemzés",
        navHome: "Kezdőlap",
        navMap: "PM2.5 Térkép",
        navMapCO2: "CO₂ Térkép",
        navHeatmap: "Hőtérkép",
        navComparison: "Összehasonlítás",
        navCorrelation: "Korreláció", // <-- EZ AZ ÚJ SOR
        navAbout: "Rólunk",
        periodLabel: "<strong>Válassz időszakot:</strong>",
        metricLabel: "<strong>Válassz adatot:</strong>",
        periodAll: "Összes (teljes átlag)",
        periodWinter: "Tél (Dec, Jan, Feb)",
        periodSpring: "Tavasz (Már, Ápr, Máj)",
        periodSummer: "Nyár (Jún, Júl, Aug)",
        periodAutumn: "Ősz (Szep, Okt, Nov)",
        legendTitle: "Jelmagyarázat", // ÚJ
        footer: "© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium projekt támogatásával valósul meg.",
        disclaimer: "A mérési adatok nem hitelesítettek.",
        aboutTitle: "Az oldal működése",
        aboutText: "Ez az oldal mobil szenzorok által gyűjtött, aggregált levegőminőségi adatokat (pl. PM2.5, CO2, NOx) jelenít meg egy interaktív hőtérképen. Az adatok rácsra vannak átlagolva, hogy bemutassák a területi eloszlást. A vezérlőkkel kiválaszthatja a vizsgált időszakot (szezonális vagy éves átlag) és a mért adat típusát. A 'Skála Min' és 'Skála Max' mezőkkel finomhangolhatja a vizuális skálát, hogy kiemelje az Ön számára fontos értéktartományokat."
        
      },
      en: {
        title: "Seasonal Heatmap - MFKSensor",
        mainTitle: "Heatmap Analysis",
        navHome: "Home",
        navMap: "PM2.5 Map",
        navMapCO2: "CO₂ Map",
        navHeatmap: "Heatmap",
        navComparison: "Comparison",
        navCorrelation: "Correlation", // <-- EZ AZ ÚJ SOR
        navAbout: "About",
        periodLabel: "<strong>Select period:</strong>",
        metricLabel: "<strong>Select metric:</strong>",
        periodAll: "All (total average)",
        periodWinter: "Winter (Dec, Jan, Feb)",
        periodSpring: "Spring (Mar, Apr, May)",
        periodSummer: "Summer (Jun, Jul, Aug)",
        periodAutumn: "Autumn (Sep, Oct, Nov)",
        legendTitle: "Legend", // ÚJ
        footer: "© Realized with the support of the National Multidisciplinary Laboratory for Climate Change project.",
        disclaimer: "Measurement data is not verified.",
        aboutTitle: "How This Page Works",
        aboutText: "This page displays aggregated air quality data (e.g., PM2.5, CO2, NOx) collected by mobile sensors on an interactive heatmap. The data is averaged onto a grid to show spatial distribution. You can use the controls to select the period (seasonal or annual average) and the metric type. The 'Scale Min' and 'Scale Max' fields allow you to fine-tune the visual scale to highlight the value ranges that are important to you."
        
      }
    };

    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      applyLanguage(lang);
    }

    function applyLanguage(lang) {
      const langData = translations[lang];
      document.title = langData.title;
      document.getElementById('main-title').textContent = langData.mainTitle;
      document.getElementById('nav-home').textContent = langData.navHome;
      document.getElementById('nav-map').textContent = langData.navMap;
      document.getElementById('nav-map-co2').textContent = langData.navMapCO2;
      document.getElementById('nav-heatmap').textContent = langData.navHeatmap;
      document.getElementById('nav-comparison').textContent = langData.navComparison;
      document.getElementById('nav-correlation').textContent = langData.navCorrelation;
      document.getElementById('nav-about').textContent = langData.navAbout;
      document.getElementById('period-label').innerHTML = langData.periodLabel;
      document.getElementById('metric-label').innerHTML = langData.metricLabel;
      document.getElementById('period-all').textContent = langData.periodAll;
      document.getElementById('period-winter').textContent = langData.periodWinter;
      document.getElementById('period-spring').textContent = langData.periodSpring;
      document.getElementById('period-summer').textContent = langData.periodSummer;
      document.getElementById('period-autumn').textContent = langData.periodAutumn;
      document.getElementById('footer-text').textContent = langData.footer;
      document.getElementById('disclaimer-text').textContent = langData.disclaimer;
      document.getElementById('about-title').textContent = langData.aboutTitle;
      document.getElementById('about-text').textContent = langData.aboutText;
      document.documentElement.lang = lang;
      
     

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // ÚJ: Frissítse a jelmagyarázatot is, ha már létezik
      if (legendControl) {
          updateHeatmap(); // Egyszerűbb újrahívni a heatmap-et, ami újragenerálja a jelmagyarázatot
      }
    }
    
    function setAnalysisMode(mode) {
        currentAnalysisMode = mode;
        if (mode === 'polluted') {
            pollutedBtn.classList.add('active');
            allBtn.classList.remove('active');
        } else {
            pollutedBtn.classList.remove('active');
            allBtn.classList.add('active');
        }
    // Amikor módot váltunk, frissítsük a térképet
        updateHeatmap();
    }

document.addEventListener('DOMContentLoaded', () => {
  const savedLang = localStorage.getItem('language') || 'hu';
  setLanguage(savedLang);

  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      setLanguage(btn.dataset.lang);
    });
  });

  // ▼▼▼ ÚJ ESEMÉNYKEZELŐK ▼▼▼
  pollutedBtn.addEventListener('click', () => setAnalysisMode('polluted'));
  allBtn.addEventListener('click', () => setAnalysisMode('all'));
  // ▲▲▲ VÉGE ▲▲▲

  // Módosított indítás:
  // updateHeatmap(); // Ehelyett:
  setAnalysisMode(currentAnalysisMode); // Hogy az alapértelmezett mód betöltődjön
});

</script>

</body>
</html>