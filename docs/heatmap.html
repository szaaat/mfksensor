<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szezonális Hőtérkép - MFKSensor</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #map { height: 75vh; width: 100%; }
        #loading-spinner {
            display: none; margin-left: 15px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lang-btn {
          padding: 2px 10px; border: 1px solid white; border-radius: 4px;
          background: transparent; color: white; cursor: pointer; transition: all 0.3s;
        }
        .lang-btn.active { background: white; color: green; font-weight: bold; }
        .lang-btn:hover:not(.active) { background: rgba(255,255,255,0.2); }
        
        /* ÚJ: Jelmagyarázat stílusa */
        .info.legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        .legend-gradient {
            width: 30px;
            height: 150px;
            border: 1px solid #ccc;
        }
        .legend-labels {
            position: relative;
            height: 150px;
            width: 30px;
            float: right;
            margin-left: 5px;
        }
        .legend-labels span {
            position: absolute;
            left: 5px;
            font-size: 12px;
            color: #333;
        }
        .legend-labels .max { top: 0; }
        .legend-labels .mid { top: 50%; transform: translateY(-50%); }
        .legend-labels .min { bottom: 0; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 font-sans min-h-screen flex flex-col">

<header class="bg-green-700 text-white text-center py-8 shadow-lg relative">
    <div class="absolute top-4 right-4 flex space-x-2">
      <button id="lang-hu" class="lang-btn active" data-lang="hu">HU</button>
      <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
    </div>
    <h1 id="main-title" class="text-2xl md:text-4xl font-extrabold tracking-tight">Hőtérkép Elemzés</h1>
</header>

<nav class="bg-green-600 text-white py-4 shadow-md">
    <div class="container mx-auto px-6 flex flex-wrap justify-center gap-x-8 gap-y-2">
      <a href="/mfksensor/" id="nav-home" class="text-lg font-semibold hover:text-green-200 transition-colors">Kezdőlap</a>
      <a href="/mfksensor/map.html" id="nav-map" class="text-lg font-semibold hover:text-green-200 transition-colors">Térkép</a>
      <a href="/mfksensor/heatmap.html" id="nav-heatmap" class="text-lg font-semibold hover:text-green-200 transition-colors underline decoration-2">Hőtérkép</a>
      <a href="/mfksensor/comparison.html" id="nav-comparison" class="text-lg font-semibold hover:text-green-200 transition-colors">Összehasonlítás</a>
      <a href="/mfksensor/about.html" id="nav-about" class="text-lg font-semibold hover:text-green-200 transition-colors">Rólunk</a>
    </div>
</nav>

<div class="controls text-center p-4 bg-gray-100 shadow-sm">
    <label for="period-select" id="period-label" class="font-semibold text-gray-700">Válassz időszakot:</label>
    <select id="period-select" class="mx-2 p-2 rounded border border-gray-300">
        <option id="period-all" value="annual">Összes (teljes átlag)</option>
        <option id="period-winter" value="winter">Tél (Dec, Jan, Feb)</option>
        <option id="period-spring" value="spring">Tavasz (Már, Ápr, Máj)</option>
        <option id="period-summer" value="summer">Nyár (Jún, Júl, Aug)</option>
        <option id="period-autumn" value="autumn">Ősz (Szep, Okt, Nov)</option>
    </select>
    <label for="metric-select" id="metric-label" class="ml-4 font-semibold text-gray-700">Válassz adatot:</label>
    <select id="metric-select" class="mx-2 p-2 rounded border border-gray-300">
        <option value="pm2_5">PM2.5</option>
        <option value="pm10_0">PM10.0</option>
        <option value="co2">CO2</option>
        <option value="temperature">Hőmérséklet</option>
        <option value="humidity">Páratartalom</option>
        <option value="voc">VOC Index</option>
        <option value="nox">NOx Index</option>
        <option value="pm1_0">PM1.0</option>
        <option value="pm4_0">PM4.0</option>
    </select>
    <div id="loading-spinner"></div>
</div>

<div id="map" class="flex-grow"></div>

<footer class="bg-green-700 text-white text-center py-4 mt-auto">
    <p id="footer-text" class="text-sm">© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium projekt támogatásával valósul meg.</p>
    <p id="disclaimer-text" class="text-sm text-red-600 mt-2 font-semibold">A mérési adatok nem hitelesítettek.</p>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = 'https://yuamroqhxrflusxeyylp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NjA2ODgsImV4cCI6MjA2MTQzNjY4OH0.GOzgzWLxQnT6YzS8z2D4OKrsHkBnS55L7oRTMsEKs8U';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // -----------------------------------------------------------------
    // 2. METRIKA KONFIG (▼▼▼ MÓDOSÍTVA ▼▼▼)
    // -----------------------------------------------------------------
    // Még alacsonyabb 'max' értékek és új színátmenet (kékkel kezdve)
    // Hozzáadva 'min' és 'unit' a jelmagyarázathoz
    const METRIC_CONFIG = {
        'pm1_0':       { max: 20, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm2_5':       { max: 20, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm4_0':       { max: 30, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'pm10_0':      { max: 40, min: 0, unit: 'µg/m³', gradient: { 0.4: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } },
        'temperature': { max: 35, min: 0, unit: '°C',  gradient: { 0.0: '#0000FF', 0.5: '#FFFF00', 1: '#FF0000' } },
        'humidity':    { max: 100, min: 0, unit: '%',   gradient: { 0.4: '#FFFF00', 0.7: '#00FFFF', 1: '#0000FF' } },
        'voc':         { max: 200, min: 0, unit: 'index', gradient: { 0.2: 'green', 0.6: 'orange', 1: 'red' } },
        'nox':         { max: 80,  min: 0, unit: 'index', gradient: { 0.2: 'green', 0.6: 'orange', 1: 'red' } },
        // CO2 skála 400ppm körül indul (légköri alap)
        'co2':         { max: 1200, min: 400, unit: 'ppm', gradient: { 0.33: 'blue', 0.6: 'green', 0.8: 'yellow', 1: 'red' } } 
    };
    const DEFAULT_CONFIG = { max: 100, min: 0, unit: '', gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' } };

    const map = L.map('map').setView([47.95, 20.55], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let heatLayer = null;
    let legendControl = null; // ÚJ: Változó a jelmagyarázat tárolására
    const loadingSpinner = document.getElementById('loading-spinner');
    const periodSelect = document.getElementById('period-select');
    const metricSelect = document.getElementById('metric-select');

    // ÚJ: Helper függvény a CSS színátmenet generálásához
    function createGradientCSS(gradient) {
        const stops = Object.entries(gradient).sort(([a], [b]) => a - b);
        const cssStops = stops.map(([stop, color]) => `${color} ${stop * 100}%`);
        return `linear-gradient(to top, ${cssStops.join(', ')})`;
    }

    // -----------------------------------------------------------------
    // 4. ADATLEKÉRÉS (▼▼▼ MÓDOSÍTVA ▼▼▼)
    // -----------------------------------------------------------------
    async function updateHeatmap() {
        const period = periodSelect.value;
        const metric = metricSelect.value;
        const config = METRIC_CONFIG[metric] || DEFAULT_CONFIG;
        loadingSpinner.style.display = 'inline-block';

        try {
            const { data, error } = await supabaseClient.rpc('get_heatmap_data', {
                period_filter: period,
                metric: metric,
                grid_size: 0.001
            });

            if (error) throw error;
            if (heatLayer) map.removeLayer(heatLayer);
            
            // ÚJ: Jelmagyarázat eltávolítása
            if (legendControl) map.removeControl(legendControl);

            if (data.length === 0) {
                console.log("Nincs adat erre a szűrésre.");
                return;
            }

            const heatData = data.map(p => [p.lat, p.lon, p.intensity]);
            
            // ▼▼▼ MÓDOSÍTVA: Élesebb pontok (radius: 12, blur: 8) ▼▼▼
            heatLayer = L.heatLayer(heatData, {
                radius: 12,
                blur: 8,
                maxZoom: 18,
                max: config.max,
                gradient: config.gradient
            }).addTo(map);

            // -----------------------------------------------------------------
            // 5. ÚJ: JELMAGYARÁZAT HOZZÁADÁSA
            // -----------------------------------------------------------------
            legendControl = L.control({position: 'bottomright'});
            legendControl.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const gradientCSS = createGradientCSS(config.gradient);
                const currentLang = localStorage.getItem('language') || 'hu';
                const title = translations[currentLang].legendTitle + ` (${config.unit})`;

                div.innerHTML = `
                    <div class="legend-title">${title}</div>
                    <div style="display: flex;">
                        <div class="legend-gradient" style="background: ${gradientCSS};"></div>
                        <div class="legend-labels">
                            <span class="max">${config.max}</span>
                            <span class="mid">${(config.max + config.min) / 2}</span>
                            <span class="min">${config.min}</span>
                        </div>
                    </div>
                `;
                return div;
            };
            legendControl.addTo(map);

        } catch (error) {
            console.error('Hiba a hőtérkép adatok lekérése közben:', error.message);
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    periodSelect.addEventListener('change', updateHeatmap);
    metricSelect.addEventListener('change', updateHeatmap);
</script>

<script>
    const translations = {
      hu: {
        title: "Szezonális Hőtérkép - MFKSensor",
        mainTitle: "Hőtérkép Elemzés",
        navHome: "Kezdőlap",
        navMap: "Térkép",
        navHeatmap: "Hőtérkép",
        navComparison: "Összehasonlítás",
        navAbout: "Rólunk",
        periodLabel: "<strong>Válassz időszakot:</strong>",
        metricLabel: "<strong>Válassz adatot:</strong>",
        periodAll: "Összes (teljes átlag)",
        periodWinter: "Tél (Dec, Jan, Feb)",
        periodSpring: "Tavasz (Már, Ápr, Máj)",
        periodSummer: "Nyár (Jún, Júl, Aug)",
        periodAutumn: "Ősz (Szep, Okt, Nov)",
        legendTitle: "Jelmagyarázat", // ÚJ
        footer: "© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium projekt támogatásával valósul meg.",
        disclaimer: "A mérési adatok nem hitelesítettek."
      },
      en: {
        title: "Seasonal Heatmap - MFKSensor",
        mainTitle: "Heatmap Analysis",
        navHome: "Home",
        navMap: "Map",
        navHeatmap: "Heatmap",
        navComparison: "Comparison",
        navAbout: "About",
        periodLabel: "<strong>Select period:</strong>",
        metricLabel: "<strong>Select metric:</strong>",
        periodAll: "All (total average)",
        periodWinter: "Winter (Dec, Jan, Feb)",
        periodSpring: "Spring (Mar, Apr, May)",
        periodSummer: "Summer (Jun, Jul, Aug)",
        periodAutumn: "Autumn (Sep, Oct, Nov)",
        legendTitle: "Legend", // ÚJ
        footer: "© Realized with the support of the National Multidisciplinary Laboratory for Climate Change project.",
        disclaimer: "Measurement data is not verified."
      }
    };

    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      applyLanguage(lang);
    }

    function applyLanguage(lang) {
      const langData = translations[lang];
      document.title = langData.title;
      document.getElementById('main-title').textContent = langData.mainTitle;
      document.getElementById('nav-home').textContent = langData.navHome;
      document.getElementById('nav-map').textContent = langData.navMap;
      document.getElementById('nav-heatmap').textContent = langData.navHeatmap;
      document.getElementById('nav-comparison').textContent = langData.navComparison;
      document.getElementById('nav-about').textContent = langData.navAbout;
      document.getElementById('period-label').innerHTML = langData.periodLabel;
      document.getElementById('metric-label').innerHTML = langData.metricLabel;
      document.getElementById('period-all').textContent = langData.periodAll;
      document.getElementById('period-winter').textContent = langData.periodWinter;
      document.getElementById('period-spring').textContent = langData.periodSpring;
      document.getElementById('period-summer').textContent = langData.periodSummer;
      document.getElementById('period-autumn').textContent = langData.periodAutumn;
      document.getElementById('footer-text').textContent = langData.footer;
      document.getElementById('disclaimer-text').textContent = langData.disclaimer;
      document.documentElement.lang = lang;

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // ÚJ: Frissítse a jelmagyarázatot is, ha már létezik
      if (legendControl) {
          updateHeatmap(); // Egyszerűbb újrahívni a heatmap-et, ami újragenerálja a jelmagyarázatot
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedLang = localStorage.getItem('language') || 'hu';
      setLanguage(savedLang);

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setLanguage(btn.dataset.lang);
        });
      });
      
      updateHeatmap();
    });
</script>

</body>
</html>