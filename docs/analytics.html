<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leveg≈ëmin≈ës√©gi Analitika</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.tailwindcss.com/3.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    .loading-overlay {
      position: absolute; inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stats-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      background-color: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }
    .stats-table th, .stats-table td {
      padding: 0.75rem;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.875rem;
    }
    .stats-table th {
      background-color: #f3f4f6;
      font-weight: 600;
      white-space: nowrap;
    }
    .stats-table td:first-child {
      text-align: left;
    }
    .stats-table tr.no-data td {
      opacity: 0.5;
      color: #6b7280;
    }
    
    .chart-wrapper {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }
    @media (min-width: 768px) {
      .chart-wrapper {
        grid-template-columns: 1fr 1fr;
      }
    }
    .chart-container {
        position: relative;
        height: 400px;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem;
        background: white;
    }
    .chart-controls {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .chart-controls label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
    }
    .chart-controls select {
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #d1d5db;
      background-color: #f9fafb;
    }
    .lang-btn {
      padding: 2px 10px;
      border: 1px solid white;
      border-radius: 4px;
      background: transparent;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }
    .lang-btn.active {
      background: white;
      color: green;
      font-weight: bold;
    }
    .lang-btn:hover:not(.active) {
      background: rgba(255,255,255,0.2);
    }
    .date-info {
      text-align: center;
      margin-bottom: 1rem;
      font-style: italic;
    }
    .no-data-message {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-size: 1.1rem;
      background: white;
      border-radius: 0.5rem;
      margin: 2rem auto;
      max-width: 500px;
    }
    .data-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .summary-card {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    .summary-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #16a34a;
    }
    .summary-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 font-sans min-h-screen flex flex-col">
  <header class="bg-green-700 text-white text-center py-8 shadow-lg relative">
    <div class="absolute top-4 right-4 flex space-x-2">
      <button id="lang-hu" class="lang-btn active" data-lang="hu">HU</button>
      <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
    </div>
    <h1 id="main-title" class="text-2xl md:text-4xl font-extrabold tracking-tight">Leveg≈ëmin≈ës√©gi Analitika</h1>
  </header>

  <nav class="bg-green-600 text-white py-4 shadow-md">
    <div class="container mx-auto px-6 flex flex-wrap justify-center gap-x-8 gap-y-2">
      <a href="/mfksensor/" id="nav-home" class="text-lg font-semibold hover:text-green-200 transition-colors">Kezd≈ëlap</a>
      <a href="/mfksensor/map.html" id="nav-map" class="text-lg font-semibold hover:text-green-200 transition-colors">PM2.5 T√©rk√©p</a>
      <a href="/mfksensor/map_co2.html" id="nav-map-co2" class="text-lg font-semibold hover:text-green-200 transition-colors">CO‚ÇÇ T√©rk√©p</a>
      <a href="/mfksensor/heatmap.html" id="nav-heatmap" class="text-lg font-semibold hover:text-green-200 transition-colors">H≈ët√©rk√©p</a>
      <a href="/mfksensor/comparison.html" id="nav-comparison" class="text-lg font-semibold hover:text-green-200 transition-colors">√ñsszehasonl√≠t√°s</a>
      <a href="/mfksensor/correlation.html" id="nav-correlation" class="text-lg font-semibold hover:text-green-200 transition-colors">Korrel√°ci√≥</a>
      <a href="/mfksensor/analytics.html" id="nav-analytics" class="text-lg font-semibold hover:text-green-200 transition-colors underline decoration-2">Analitika</a>
      <a href="/mfksensor/about.html" id="nav-about" class="text-lg font-semibold hover:text-green-200 transition-colors">R√≥lunk</a>
    </div>
  </nav>

  <div class="container mx-auto p-6 flex-grow relative">
    <div class="mb-6 bg-white p-4 rounded-lg shadow-md">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2">
          <label for="datePicker" id="date-label" class="text-md font-semibold text-gray-700 whitespace-nowrap">V√°lassz d√°tumot:</label>
          <input type="text" id="datePicker" class="border rounded px-3 py-2 w-40" placeholder="√â√â√â√â-HH-NN" />
        </div>
        <div class="flex gap-2">
          <button id="prev-day" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">‚Üê El≈ëz≈ë nap</button>
          <button id="next-day" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">K√∂vetkez≈ë nap ‚Üí</button>
        </div>
      </div>
      <div id="date-info" class="date-info mt-2 text-gray-600"></div>
    </div>

    <div id="loading" class="loading-overlay hidden">
      <div class="loading-spinner"></div>
      <span id="loading-text" class="ml-4 text-lg font-semibold">Adatok bet√∂lt√©se...</span>
    </div>
    
    <div id="no-data-message" class="no-data-message hidden">
      <div class="text-4xl mb-4">üìä</div>
      <p id="no-data-text" class="font-semibold">Nincsenek adatok a kiv√°lasztott d√°tumra.</p>
      <p id="select-other-date" class="text-sm mt-2 text-gray-500">K√©rj√ºk, v√°lassz m√°sik d√°tumot vagy ellen≈ërizd, hogy vannak-e m√©r√©sek az adott napon.</p>
    </div>
    
    <div id="statsContainer" class="stats-container hidden">
      <div id="data-summary" class="data-summary hidden">
        <div class="summary-card">
          <div class="summary-value" id="total-measurements">0</div>
          <div class="summary-label">√ñsszes m√©r√©s</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="morning-count">0</div>
          <div class="summary-label">D√©lel≈ëtti m√©r√©sek</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="afternoon-count">0</div>
          <div class="summary-label">D√©lut√°ni m√©r√©sek</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="time-range">0 √≥ra</div>
          <div class="summary-label">Id≈ëtartam</div>
        </div>
      </div>

      <h2 id="stats-title" class="text-xl font-semibold mb-4 text-center">Leveg≈ëmin≈ës√©gi Statisztik√°k</h2>
      
      <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
        <h3 class="font-semibold text-blue-800 mb-3 text-center">Diagram be√°ll√≠t√°sok</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="chart-type" class="block text-sm font-medium text-gray-700 mb-1">Diagram t√≠pusa:</label>
            <select id="chart-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option value="line">Vonalas diagram</option>
              <option value="bar">Oszlopdiagram</option>
            </select>
          </div>
          <div>
            <label for="time-aggregation" class="block text-sm font-medium text-gray-700 mb-1">Id≈ë aggreg√°l√°s:</label>
            <select id="time-aggregation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option value="raw">Eredeti m√©r√©sek</option>
              <option value="5min">5 perces √°tlag</option>
              <option value="15min">15 perces √°tlag</option>
              <option value="hourly">√ìr√°s √°tlag</option>
            </select>
          </div>
        </div>
      </div>

      <div class="chart-wrapper">
        <div class="bg-white p-4 rounded-lg shadow-sm border">
          <h3 id="morning-title" class="text-center font-semibold text-gray-700 mb-3">D√©lel≈ëtt (0-12 √≥ra)</h3>
          <div class="chart-controls">
            <label for="morning-y1" id="morning-y1-label" class="whitespace-nowrap">Metrika 1:</label>
            <select id="morning-y1" class="flex-1">
              <option value="pm2_5" selected>PM2.5</option>
              <option value="pm25_bg">PM2.5 H√°tt√©r</option>
              <option value="pm25_diff">PM2.5 K√ºl√∂nbs√©g</option> <option value="temperature">H≈ëm√©rs√©klet</option>
              <option value="humidity">P√°ratartalom</option>
              <option value="co2">CO‚ÇÇ</option>
              <option value="co2_bg">CO‚ÇÇ H√°tt√©r</option>
              <option value="co2_diff">CO‚ÇÇ K√ºl√∂nbs√©g</option> <option value="voc">VOC</option>
              <option value="nox">NOx</option>
              <option value="altitude">Magass√°g</option>
            </select>
            <label for="morning-y2" id="morning-y2-label" class="whitespace-nowrap">Metrika 2:</label>
            <select id="morning-y2" class="flex-1">
              <option value="pm2_5">PM2.5</option>
              <option value="pm25_bg">PM2.5 H√°tt√©r</option>
              <option value="pm25_diff">PM2.5 K√ºl√∂nbs√©g</option> <option value="temperature" selected>H≈ëm√©rs√©klet</option>
              <option value="humidity">P√°ratartalom</option>
              <option value="co2">CO‚ÇÇ</option>
              <option value="co2_bg">CO‚ÇÇ H√°tt√©r</option>
              <option value="co2_diff">CO‚ÇÇ K√ºl√∂nbs√©g</option> <option value="voc">VOC</option>
              <option value="nox">NOx</option>
              <option value="altitude">Magass√°g</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="morningChart"></canvas>
          </div>
        </div>
        
        <div class="bg-white p-4 rounded-lg shadow-sm border">
          <h3 id="afternoon-title" class="text-center font-semibold text-gray-700 mb-3">D√©lut√°n (12-24 √≥ra)</h3>
          <div class="chart-controls">
            <label for="afternoon-y1" id="afternoon-y1-label" class="whitespace-nowrap">Metrika 1:</label>
            <select id="afternoon-y1" class="flex-1">
              <option value="pm2_5" selected>PM2.5</option>
              <option value="pm25_bg">PM2.5 H√°tt√©r</option>
              <option value="pm25_diff">PM2.5 K√ºl√∂nbs√©g</option> <option value="temperature">H≈ëm√©rs√©klet</option>
              <option value="humidity">P√°ratartalom</option>
              <option value="co2">CO‚ÇÇ</option>
              <option value="co2_bg">CO‚ÇÇ H√°tt√©r</option>
              <option value="co2_diff">CO‚ÇÇ K√ºl√∂nbs√©g</option> <option value="voc">VOC</option>
              <option value="nox">NOx</option>
              <option value="altitude">Magass√°g</option>
            </select>
            <label for="afternoon-y2" id="afternoon-y2-label" class="whitespace-nowrap">Metrika 2:</label>
            <select id="afternoon-y2" class="flex-1">
              <option value="pm2_5">PM2.5</option>
              <option value="pm25_bg">PM2.5 H√°tt√©r</option>
              <option value="pm25_diff">PM2.5 K√ºl√∂nbs√©g</option> <option value="temperature" selected>H≈ëm√©rs√©klet</option>
              <option value="humidity">P√°ratartalom</option>
              <option value="co2">CO‚ÇÇ</option>
              <option value="co2_bg">CO‚ÇÇ H√°tt√©r</option>
              <option value="co2_diff">CO‚ÇÇ K√ºl√∂nbs√©g</option> <option value="voc">VOC</option>
              <option value="nox">NOx</option>
              <option value="altitude">Magass√°g</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="afternoonChart"></canvas>
          </div>
        </div>
      </div>

      <div class="mt-8 bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-lg font-semibold mb-4 text-center">R√©szletes statisztik√°k</h3>
        <div class="overflow-x-auto">
          <table id="statsTable" class="stats-table w-full">
            <thead>
              <tr>
                <th id="metric-header">Metrika</th>
                <th id="period-header">Id≈ëszak</th>
                <th id="datapoint-header">M√©r√©sek</th>
                <th id="average-header">√Åtlag</th>
                <th id="median-header">Medi√°n</th>
                <th id="min-header">Minimum</th>
                <th id="max-header">Maximum</th>
              </tr>
            </thead>
            <tbody id="statsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="text-center mt-6">
      <button id="exportButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-md">Adatok export√°l√°sa CSV-k√©nt</button>
    </div>
  </div>

  <footer class="bg-green-700 text-white text-center py-4 mt-auto">
    <p id="footer-text" class="text-sm">¬© √âghajlatv√°ltoz√°s Multidiszciplin√°ris Nemzeti Laborat√≥rium projekt t√°mogat√°s√°val val√≥sul meg.</p>
    <p id="disclaimer-text" class="text-sm text-red-600 mt-2 font-semibold">A m√©r√©si adatok nem hiteles√≠tettek.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/hu.js"></script>
  
  <script>
    let morningChartInstance = null;
    let afternoonChartInstance = null;
    let currentDayData = [];
    let availableDates = [];
    let currentDate = null;

    // √öJ: Kib≈ëv√≠tett metrika defin√≠ci√≥k
    const metricsDetails = {
      'pm2_5': { label: 'PM2.5 (¬µg/m¬≥)', color: 'rgb(234, 88, 12)', unit: '¬µg/m¬≥' },
      'pm25_bg': { label: 'PM2.5 H√°tt√©r (¬µg/m¬≥)', color: 'rgb(251, 146, 60)', unit: '¬µg/m¬≥' },
      'pm25_diff': { label: 'PM2.5 K√ºl√∂nbs√©g (¬µg/m¬≥)', color: 'rgb(194, 65, 12)', unit: '¬µg/m¬≥' }, // √öJ: S√∂t√©tebb narancs
      'temperature': { label: 'H≈ëm√©rs√©klet (¬∞C)', color: 'rgb(37, 99, 235)', unit: '¬∞C' },
      'humidity': { label: 'P√°ratartalom (%)', color: 'rgb(22, 163, 74)', unit: '%' },
      'co2': { label: 'CO‚ÇÇ (ppm)', color: 'rgb(88, 28, 135)', unit: 'ppm' },
      'co2_bg': { label: 'CO‚ÇÇ H√°tt√©r (ppm)', color: 'rgb(147, 51, 234)', unit: 'ppm' },
      'co2_diff': { label: 'CO‚ÇÇ K√ºl√∂nbs√©g (ppm)', color: 'rgb(76, 29, 149)', unit: 'ppm' }, // √öJ: S√∂t√©tebb lila
      'voc': { label: 'VOC (ppb)', color: 'rgb(220, 38, 38)', unit: 'ppb' },
      'nox': { label: 'NOx (ppb)', color: 'rgb(139, 69, 19)', unit: 'ppb' },
      'altitude': { label: 'Magass√°g (m)', color: 'rgb(75, 85, 99)', unit: 'm' }
    };

    // Ford√≠t√°si adatok
    const translations = {
      hu: {
        title: "Leveg≈ëmin≈ës√©gi Analitika",
        mainTitle: "Leveg≈ëmin≈ës√©gi Analitika",
        navHome: "Kezd≈ëlap", navMap: "PM2.5 T√©rk√©p", navMapCO2: "CO‚ÇÇ T√©rk√©p", navHeatmap: "H≈ët√©rk√©p",
        navComparison: "√ñsszehasonl√≠t√°s", navCorrelation: "Korrel√°ci√≥", navAnalytics: "Analitika", navAbout: "R√≥lunk",
        dateLabel: "V√°lassz d√°tumot:",
        loadingText: "Adatok bet√∂lt√©se...",
        statsTitle: "Leveg≈ëmin≈ës√©gi Statisztik√°k",
        morningTitle: "D√©lel≈ëtt (0-12 √≥ra)",
        afternoonTitle: "D√©lut√°n (12-24 √≥ra)",
        morningY1Label: "Metrika 1:", morningY2Label: "Metrika 2:",
        afternoonY1Label: "Metrika 1:", afternoonY2Label: "Metrika 2:",
        metricHeader: "Metrika", periodHeader: "Id≈ëszak", datapointHeader: "M√©r√©sek",
        averageHeader: "√Åtlag", medianHeader: "Medi√°n", minHeader: "Minimum", maxHeader: "Maximum",
        exportButton: "Adatok export√°l√°sa CSV-k√©nt",
        footer: "¬© √âghajlatv√°ltoz√°s Multidiszciplin√°ris Nemzeti Laborat√≥rium projekt t√°mogat√°s√°val val√≥sul meg.",
        disclaimer: "A m√©r√©si adatok nem hiteles√≠tettek.",
        noData: "Nincsenek adatok a kiv√°lasztott d√°tumra.",
        selectOtherDate: "K√©rj√ºk, v√°lassz m√°sik d√°tumot vagy ellen≈ërizd, hogy vannak-e m√©r√©sek az adott napon.",
        chartType: "Diagram t√≠pusa:",
        timeAggregation: "Id≈ë aggreg√°l√°s:",
        timeRaw: "Eredeti m√©r√©sek",
        time5min: "5 perces √°tlag",
        time15min: "15 perces √°tlag",
        timeHourly: "√ìr√°s √°tlag"
      },
      en: {
        title: "Air Quality Analytics",
        mainTitle: "Air Quality Analytics",
        navHome: "Home", navMap: "PM2.5 Map", navMapCO2: "CO‚ÇÇ Map", navHeatmap: "Heatmap",
        navComparison: "Comparison", navCorrelation: "Correlation", navAnalytics: "Analytics", navAbout: "About",
        dateLabel: "Select date:",
        loadingText: "Loading data...",
        statsTitle: "Air Quality Statistics",
        morningTitle: "Morning (0-12 hours)",
        afternoonTitle: "Afternoon (12-24 hours)",
        morningY1Label: "Metric 1:", morningY2Label: "Metric 2:",
        afternoonY1Label: "Metric 1:", afternoonY2Label: "Metric 2:",
        metricHeader: "Metric", periodHeader: "Period", datapointHeader: "Measurements",
        averageHeader: "Average", medianHeader: "Median", minHeader: "Minimum", maxHeader: "Maximum",
        exportButton: "Export Data as CSV",
        footer: "¬© Realized with the support of the National Multidisciplinary Laboratory for Climate Change project.",
        disclaimer: "Measurement data is not verified.",
        noData: "No data available for selected date.",
        selectOtherDate: "Please select another date or check if there are measurements for this day.",
        chartType: "Chart type:",
        timeAggregation: "Time aggregation:",
        timeRaw: "Raw measurements",
        time5min: "5-minute average",
        time15min: "15-minute average",
        timeHourly: "Hourly average"
      }
    };

    function setLanguage(lang) {
      localStorage.setItem('language', lang);
      applyLanguage(lang);
    }

    function applyLanguage(lang) {
      const langData = translations[lang];
      document.title = langData.title;
      document.getElementById('main-title').textContent = langData.mainTitle;
      
      // Navig√°ci√≥
      document.getElementById('nav-home').textContent = langData.navHome;
      document.getElementById('nav-map').textContent = langData.navMap;
      document.getElementById('nav-map-co2').textContent = langData.navMapCO2;
      document.getElementById('nav-heatmap').textContent = langData.navHeatmap;
      document.getElementById('nav-comparison').textContent = langData.navComparison;
      document.getElementById('nav-correlation').textContent = langData.navCorrelation;
      document.getElementById('nav-analytics').textContent = langData.navAnalytics;
      document.getElementById('nav-about').textContent = langData.navAbout;
      
      // F≈ë tartalom
      document.getElementById('date-label').textContent = langData.dateLabel;
      document.getElementById('loading-text').textContent = langData.loadingText;
      document.getElementById('stats-title').textContent = langData.statsTitle;
      document.getElementById('morning-title').textContent = langData.morningTitle;
      document.getElementById('afternoon-title').textContent = langData.afternoonTitle;
      document.getElementById('morning-y1-label').textContent = langData.morningY1Label;
      document.getElementById('morning-y2-label').textContent = langData.morningY2Label;
      document.getElementById('afternoon-y1-label').textContent = langData.afternoonY1Label;
      document.getElementById('afternoon-y2-label').textContent = langData.afternoonY2Label;
      
      // T√°bl√°zat fejl√©cek
      document.getElementById('metric-header').textContent = langData.metricHeader;
      document.getElementById('period-header').textContent = langData.periodHeader;
      document.getElementById('datapoint-header').textContent = langData.datapointHeader;
      document.getElementById('average-header').textContent = langData.averageHeader;
      document.getElementById('median-header').textContent = langData.medianHeader;
      document.getElementById('min-header').textContent = langData.minHeader;
      document.getElementById('max-header').textContent = langData.maxHeader;
      
      // Gombok
      document.getElementById('exportButton').textContent = langData.exportButton;
      
      // L√°bl√©c
      document.getElementById('footer-text').textContent = langData.footer;
      document.getElementById('disclaimer-text').textContent = langData.disclaimer;
      
      // Diagram be√°ll√≠t√°sok
      document.querySelector('label[for="chart-type"]').textContent = langData.chartType;
      document.querySelector('label[for="time-aggregation"]').textContent = langData.timeAggregation;
      document.querySelector('#time-aggregation option[value="raw"]').textContent = langData.timeRaw;
      document.querySelector('#time-aggregation option[value="5min"]').textContent = langData.time5min;
      document.querySelector('#time-aggregation option[value="15min"]').textContent = langData.time15min;
      document.querySelector('#time-aggregation option[value="hourly"]').textContent = langData.timeHourly;
      
      // Nincs adat √ºzenet
      document.getElementById('no-data-text').textContent = langData.noData;
      document.getElementById('select-other-date').textContent = langData.selectOtherDate;
      
      document.documentElement.lang = lang;
      
      // Nyelv gombok akt√≠v √°llapota
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // √öJ: Friss√≠teni kell az opci√≥k sz√∂veg√©t is nyelvv√°lt√°skor
      const metricOptions = {
        'pm2_5': 'PM2.5',
        'pm25_bg': lang === 'hu' ? 'PM2.5 H√°tt√©r' : 'PM2.5 Background',
        'pm25_diff': lang === 'hu' ? 'PM2.5 K√ºl√∂nbs√©g' : 'PM2.5 Difference', // √öJ
        'temperature': lang === 'hu' ? 'H≈ëm√©rs√©klet' : 'Temperature',
        'humidity': lang === 'hu' ? 'P√°ratartalom' : 'Humidity',
        'co2': 'CO‚ÇÇ',
        'co2_bg': lang === 'hu' ? 'CO‚ÇÇ H√°tt√©r' : 'CO‚ÇÇ Background',
        'co2_diff': lang === 'hu' ? 'CO‚ÇÇ K√ºl√∂nbs√©g' : 'CO‚ÇÇ Difference', // √öJ
        'voc': 'VOC',
        'nox': 'NOx',
        'altitude': lang === 'hu' ? 'Magass√°g' : 'Altitude'
      };

      const selects = ['morning-y1', 'morning-y2', 'afternoon-y1', 'afternoon-y2'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        Array.from(select.options).forEach(opt => {
          if(metricOptions[opt.value]) opt.text = metricOptions[opt.value];
        });
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Nyelv be√°ll√≠t√°s
      const savedLang = localStorage.getItem('language') || 'hu';
      setLanguage(savedLang);

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
      });

      const supabaseClient = supabase.createClient(
        'https://yuamroqhxrflusxeyylp.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NjA2ODgsImV4cCI6MjA2MTQzNjY4OH0.GOzgzWLxQnT6YzS8z2D4OKrsHkBnS55L7oRTMsEKs8U'
      );

      // D√°tumok bet√∂lt√©se a megl√©v≈ë RPC f√ºggv√©nnyel
      async function loadAvailableDates() {
        try {
          const { data, error } = await supabaseClient.rpc('get_distinct_dates');
          if (error) throw error;
          
          console.log('El√©rhet≈ë d√°tumok:', data);
          return data.map(item => item.date); 
        } catch (err) {
          console.error('Hiba a d√°tumok lek√©rdez√©sekor:', err);
          const today = new Date();
          const dates = [];
          for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            dates.push(date.toISOString().split('T')[0]);
          }
          return dates;
        }
      }

      // Adatlek√©rdez√©s egy adott napra
      async function fetchData(date) {
        const loading = document.getElementById('loading');
        loading.classList.remove('hidden');
        try {
          const start = `${date}T00:00:00`;
          const end = `${date}T23:59:59`;

          console.log(`Lek√©rdez√©s: ${start} - ${end}`);

          const { data, error } = await supabaseClient
            .from('air_quality_view')
            .select('*')
            .gte('timestamp', start)
            .lte('timestamp', end)
            .order('timestamp', { ascending: true });
            
          if (error) throw error;
          
          console.log(`Lek√©rdezett adatok sz√°ma (${date}):`, data ? data.length : 0);
          
          return data || [];
        } catch (err) {
          console.error('Hiba az adatok lek√©rdez√©sekor:', err);
          return [];
        } finally {
          loading.classList.add('hidden');
        }
      }

      // Id≈ë aggreg√°l√°s f√ºggv√©ny
      function aggregateData(data, interval) {
        if (interval === 'raw' || !data.length) return data;

        const aggregated = [];
        const intervalMs = {
          '5min': 5 * 60 * 1000,
          '15min': 15 * 60 * 1000,
          'hourly': 60 * 60 * 1000
        }[interval];

        let currentGroup = [];
        let groupStart = null;

        data.forEach((point, index) => {
          const timestamp = new Date(point.timestamp).getTime();
          
          if (!groupStart) {
            groupStart = timestamp;
            currentGroup = [point];
            return;
          }

          if (timestamp - groupStart < intervalMs) {
            currentGroup.push(point);
          } else {
            const avgPoint = calculateAverage(currentGroup);
            aggregated.push(avgPoint);
            
            groupStart = timestamp;
            currentGroup = [point];
          }

          if (index === data.length - 1 && currentGroup.length > 0) {
            const avgPoint = calculateAverage(currentGroup);
            aggregated.push(avgPoint);
          }
        });

        return aggregated;
      }

      function calculateAverage(points) {
        const avgPoint = { ...points[0] };
        // √öJ: Hozz√°adva az √∫j mez≈ëk a list√°hoz
        const metrics = ['pm2_5', 'pm25_bg', 'pm25_diff', 'temperature', 'humidity', 'co2', 'co2_bg', 'co2_diff', 'voc', 'nox', 'altitude'];
        
        metrics.forEach(metric => {
          const values = points.map(p => p[metric]).filter(v => v != null);
          if (values.length > 0) {
            avgPoint[metric] = values.reduce((sum, val) => sum + val, 0) / values.length;
          }
        });

        avgPoint.timestamp = points[0].timestamp;
        return avgPoint;
      }

      function updateDataSummary(data) {
        if (!data || data.length === 0) {
          document.getElementById('data-summary').classList.add('hidden');
          return;
        }

        const morningData = data.filter(item => new Date(item.timestamp).getHours() < 12);
        const afternoonData = data.filter(item => new Date(item.timestamp).getHours() >= 12);
        
        const timestamps = data.map(d => new Date(d.timestamp).getTime());
        const minTime = Math.min(...timestamps);
        const maxTime = Math.max(...timestamps);
        const hoursDiff = (maxTime - minTime) / (1000 * 60 * 60);

        document.getElementById('total-measurements').textContent = data.length;
        document.getElementById('morning-count').textContent = morningData.length;
        document.getElementById('afternoon-count').textContent = afternoonData.length;
        document.getElementById('time-range').textContent = `${hoursDiff.toFixed(1)} √≥ra`;

        document.getElementById('data-summary').classList.remove('hidden');
      }

      function updateCharts(data) {
        if (morningChartInstance) morningChartInstance.destroy();
        if (afternoonChartInstance) afternoonChartInstance.destroy();

        if (!data || data.length === 0) {
          document.getElementById('no-data-message').classList.remove('hidden');
          document.getElementById('statsContainer').classList.add('hidden');
          document.getElementById('data-summary').classList.add('hidden');
          return;
        }

        document.getElementById('no-data-message').classList.add('hidden');
        document.getElementById('statsContainer').classList.remove('hidden');

        const aggregation = document.getElementById('time-aggregation').value;
        const aggregatedData = aggregateData(data, aggregation);

        const morningData = aggregatedData.filter(item => new Date(item.timestamp).getHours() < 12);
        const afternoonData = aggregatedData.filter(item => new Date(item.timestamp).getHours() >= 12);

        const mY1 = document.getElementById('morning-y1').value;
        const mY2 = document.getElementById('morning-y2').value;
        const aY1 = document.getElementById('afternoon-y1').value;
        const aY2 = document.getElementById('afternoon-y2').value;
        const chartType = document.getElementById('chart-type').value;

        const createChart = (canvasId, chartData, y1Key, y2Key) => {
          const ctx = document.getElementById(canvasId);
          if (!ctx) return null;

          const y1Metric = metricsDetails[y1Key];
          const y2Metric = metricsDetails[y2Key];

          const labels = chartData.map(d => new Date(d.timestamp));
          const y1Data = chartData.map(d => d[y1Key]);
          const y2Data = chartData.map(d => d[y2Key]);

          return new Chart(ctx, {
            type: chartType,
            data: {
              labels: labels,
              datasets: [
                {
                  label: y1Metric.label,
                  data: y1Data,
                  borderColor: y1Metric.color,
                  backgroundColor: chartType === 'bar' ? 
                    y1Metric.color.replace(')', ', 0.7)') : 
                    y1Metric.color.replace(')', ', 0.1)'),
                  yAxisID: 'y1',
                  tension: 0.4,
                  fill: chartType === 'line'
                },
                {
                  label: y2Metric.label,
                  data: y2Data,
                  borderColor: y2Metric.color,
                  backgroundColor: chartType === 'bar' ? 
                    y2Metric.color.replace(')', ', 0.7)') : 
                    y2Metric.color.replace(')', ', 0.1)'),
                  yAxisID: 'y2',
                  tension: 0.4,
                  fill: chartType === 'line'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                },
                tooltip: {
                  mode: 'index',
                  intersect: false
                }
              },
              scales: {
                x: {
                  type: 'time',
                  time: { 
                    unit: aggregation === 'hourly' ? 'hour' : 'minute',
                    tooltipFormat: 'HH:mm',
                    displayFormats: { 
                      hour: 'HH:mm',
                      minute: 'HH:mm'
                    }
                  },
                  title: { display: true, text: 'Id≈ëpont' }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: { display: true, text: y1Metric.label }
                },
                y2: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: { display: true, text: y2Metric.label },
                  grid: { drawOnChartArea: false },
                }
              }
            }
          });
        };

        morningChartInstance = createChart('morningChart', morningData, mY1, mY2);
        afternoonChartInstance = createChart('afternoonChart', afternoonData, aY1, aY2);
      }

      function calculateStats(data) {
        const morning = data.filter(item => new Date(item.timestamp).getHours() < 12);
        const afternoon = data.filter(item => new Date(item.timestamp).getHours() >= 12);

        const getMedian = arr => {
          if (!arr.length) return 0;
          const sorted = [...arr].sort((a, b) => a - b);
          const mid = Math.floor(sorted.length / 2);
          return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        };

        const getMin = arr => {
          if (!arr.length) return 0;
          return Math.min(...arr);
        };

        const getMax = arr => {
          if (!arr.length) return 0;
          return Math.max(...arr);
        };

        const getAvg = arr => {
          if (!arr.length) return 0;
          return arr.reduce((a, b) => a + b, 0) / arr.length;
        };

        const createStatBlock = () => ({
          count: 0, avg: 0, median: 0, min: 0, max: 0
        });

        // √öJ: Kib≈ëv√≠tett statisztikai objektum
        const stats = {
          pm25: { morning: createStatBlock(), afternoon: createStatBlock() },
          pm25_bg: { morning: createStatBlock(), afternoon: createStatBlock() },
          pm25_diff: { morning: createStatBlock(), afternoon: createStatBlock() }, // √öJ
          temp: { morning: createStatBlock(), afternoon: createStatBlock() },
          hum: { morning: createStatBlock(), afternoon: createStatBlock() },
          co2: { morning: createStatBlock(), afternoon: createStatBlock() },
          co2_bg: { morning: createStatBlock(), afternoon: createStatBlock() },
          co2_diff: { morning: createStatBlock(), afternoon: createStatBlock() }, // √öJ
          voc: { morning: createStatBlock(), afternoon: createStatBlock() },
          nox: { morning: createStatBlock(), afternoon: createStatBlock() },
          altitude: { morning: createStatBlock(), afternoon: createStatBlock() }
        };

        // √öJ: Kib≈ëv√≠tett metrika t√©rk√©p
        const metricMap = {
          'pm2_5': 'pm25',
          'pm25_bg': 'pm25_bg',
          'pm25_diff': 'pm25_diff', // √öJ
          'temperature': 'temp',
          'humidity': 'hum',
          'co2': 'co2',
          'co2_bg': 'co2_bg',
          'co2_diff': 'co2_diff', // √öJ
          'voc': 'voc',
          'nox': 'nox',
          'altitude': 'altitude'
        };

        for (const [metricKey, statKey] of Object.entries(metricMap)) {
          const morningValues = morning.map(item => item[metricKey]).filter(v => v != null && !isNaN(v));
          const afternoonValues = afternoon.map(item => item[metricKey]).filter(v => v != null && !isNaN(v));

          stats[statKey].morning = {
            count: morningValues.length,
            avg: getAvg(morningValues),
            median: getMedian(morningValues),
            min: getMin(morningValues),
            max: getMax(morningValues)
          };
          stats[statKey].afternoon = {
            count: afternoonValues.length,
            avg: getAvg(afternoonValues),
            median: getMedian(afternoonValues),
            min: getMin(afternoonValues),
            max: getMax(afternoonValues)
          };
        }
        
        return stats;
      }

      function updateStatsTable(data) {
        const statsBody = document.getElementById('statsBody');
        const stats = calculateStats(data); 

        statsBody.innerHTML = ''; 
        // √öJ: Kib≈ëv√≠tett nevek a t√°bl√°zathoz
        const metricDisplayNames = {
          pm25: 'PM2.5 (¬µg/m¬≥)',
          pm25_bg: 'PM2.5 H√°tt√©r (¬µg/m¬≥)',
          pm25_diff: 'PM2.5 K√ºl√∂nbs√©g (¬µg/m¬≥)', // √öJ
          temp: 'H≈ëm√©rs√©klet (¬∞C)',
          hum: 'P√°ratartalom (%)',
          co2: 'CO‚ÇÇ (ppm)',
          co2_bg: 'CO‚ÇÇ H√°tt√©r (ppm)',
          co2_diff: 'CO‚ÇÇ K√ºl√∂nbs√©g (ppm)', // √öJ
          voc: 'VOC (ppb)',
          nox: 'NOx (ppb)',
          altitude: 'Magass√°g (m)'
        };

        for (const [metricKey, displayName] of Object.entries(metricDisplayNames)) {
          ['morning', 'afternoon'].forEach(period => {
            const periodName = period === 'morning' ? 'D√©lel≈ëtt' : 'D√©lut√°n';
            const statData = stats[metricKey][period];
            const row = document.createElement('tr');
            
            if (statData.count > 0) {
              row.innerHTML = `
                <td><strong>${displayName}</strong></td>
                <td>${periodName}</td>
                <td>${statData.count}</td>
                <td>${statData.avg.toFixed(1)}</td>
                <td>${statData.median.toFixed(1)}</td>
                <td>${statData.min.toFixed(1)}</td>
                <td>${statData.max.toFixed(1)}</td>
              `;
            } else {
              row.classList.add('no-data');
              row.innerHTML = `
                <td><strong>${displayName}</strong></td>
                <td>${periodName}</td>
                <td>0</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>N/A</td>
              `;
            }
            statsBody.appendChild(row);
          });
        }
      }

      function updateDateInfo(date, dataCount) {
        const dateInfo = document.getElementById('date-info');
        const lang = localStorage.getItem('language') || 'hu';
        
        if (dataCount > 0) {
          dateInfo.textContent = lang === 'hu' 
            ? `${date} - ${dataCount} m√©r√©si adat`
            : `${date} - ${dataCount} measurements`;
          dateInfo.style.color = '#16a34a';
        } else {
          dateInfo.textContent = lang === 'hu' 
            ? `${date} - Nincsenek adatok`
            : `${date} - No data`;
          dateInfo.style.color = '#dc2626';
        }
      }

      async function loadDate(date) {
        currentDate = date;
        const data = await fetchData(date);
        currentDayData = data;
        
        updateDateInfo(date, data.length);
        updateDataSummary(data);
        updateCharts(data);
        updateStatsTable(data);
      }

      async function initializeAnalytics() {
        availableDates = await loadAvailableDates();
        const datePicker = document.getElementById('datePicker');
        
        // D√°tumv√°laszt√≥ be√°ll√≠t√°sa
        flatpickr("#datePicker", {
          locale: 'hu',
          dateFormat: "Y-m-d",
          enable: availableDates,
          defaultDate: availableDates.length > 0 ? availableDates[0] : new Date(),
          onChange: async (selectedDates) => {
            if (selectedDates.length > 0) {
              const date = selectedDates[0].toISOString().split('T')[0];
              await loadDate(date);
            }
          }
        });

        // El≈ëz≈ë/K√∂vetkez≈ë nap gombok
        document.getElementById('prev-day').addEventListener('click', () => {
          if (!currentDate) return;
          
          const currentIndex = availableDates.indexOf(currentDate);
          if (currentIndex < availableDates.length - 1) {
            const prevDate = availableDates[currentIndex + 1];
            datePicker._flatpickr.setDate(prevDate);
            loadDate(prevDate);
          }
        });

        document.getElementById('next-day').addEventListener('click', () => {
          if (!currentDate) return;
          
          const currentIndex = availableDates.indexOf(currentDate);
          if (currentIndex > 0) {
            const nextDate = availableDates[currentIndex - 1];
            datePicker._flatpickr.setDate(nextDate);
            loadDate(nextDate);
          }
        });

        // Diagram be√°ll√≠t√°sok v√°ltoz√°sai
        document.getElementById('chart-type').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('time-aggregation').addEventListener('change', () => updateCharts(currentDayData));

        // Metrika v√°laszt√≥k v√°ltoz√°sai
        document.getElementById('morning-y1').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('morning-y2').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('afternoon-y1').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('afternoon-y2').addEventListener('change', () => updateCharts(currentDayData));

        // Kezdeti d√°tum bet√∂lt√©se
        if (availableDates.length > 0) {
          const latestDate = availableDates[0];
          datePicker._flatpickr.setDate(latestDate);
          await loadDate(latestDate);
        } else {
          const today = new Date().toISOString().split('T')[0];
          await loadDate(today);
        }
      }

      // Export funkci√≥
      document.getElementById('exportButton').addEventListener('click', () => {
        if (!currentDate || currentDayData.length === 0) {
          const lang = localStorage.getItem('language') || 'hu';
          alert(lang === 'hu' ? 'Nincsenek export√°lhat√≥ adatok!' : 'No data available for export!');
          return;
        }

        const csvRows = [];
        // √öJ: Fejl√©c b≈ëv√≠t√©se
        const headers = ['Id≈ëb√©lyeg', 'PM2.5', 'PM2.5 H√°tt√©r', 'PM2.5 K√ºl√∂nbs√©g', 'H≈ëm√©rs√©klet', 'P√°ratartalom', 'CO2', 'CO2 H√°tt√©r', 'CO2 K√ºl√∂nbs√©g', 'VOC', 'NOx', 'Magass√°g'];
        csvRows.push(headers.join(','));

        currentDayData.forEach(row => {
          const csvRow = [
            row.timestamp,
            row.pm2_5 || '',
            row.pm25_bg || '',
            row.pm25_diff || '', // √öJ
            row.temperature || '',
            row.humidity || '',
            row.co2 || '',
            row.co2_bg || '',
            row.co2_diff || '', // √öJ
            row.voc || '',
            row.nox || '',
            row.altitude || ''
          ].map(field => `"${field}"`).join(',');
          csvRows.push(csvRow);
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `levego_minoseg_${currentDate}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      });

      initializeAnalytics();
    });
  </script>
</body>
</html>