<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Levegőminőségi Analitika</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    .loading-overlay {
      position: absolute; inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stats-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
      background-color: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }
    .stats-table th, .stats-table td {
      padding: 0.75rem;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.875rem;
    }
    .stats-table th {
      background-color: #f3f4f6;
      font-weight: 600;
      white-space: nowrap;
    }
    .stats-table td:first-child {
      text-align: left;
    }
    .stats-table tr.no-data td {
      opacity: 0.5;
      color: #6b7280;
    }
    
    .chart-wrapper {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }
    @media (min-width: 768px) {
      .chart-wrapper {
        grid-template-columns: 1fr 1fr;
      }
    }
    .chart-container {
        position: relative;
        height: 300px;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }
    /* === ÚJ: Diagram vezérlők === */
    .chart-controls {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 0.5rem;
    }
    .chart-controls label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      align-self: center;
    }
    .chart-controls select {
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #d1d5db;
      background-color: #f9fafb;
    }
    /* ============================ */

  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 font-sans min-h-screen flex flex-col">
  <header class="bg-green-700 text-white text-center py-8 shadow-lg">
    <h1 class="text-2xl md:text-3xl font-bold">ÉMNL 7B alprojekt – Levegőminőségi Analitika</h1>
    <nav class="mt-2">
      <a href="/mfksensor/" class="underline text-sm hover:text-green-300">← Vissza a kezdőlapra</a>
    </nav>
  </header>
  <nav class="bg-green-600 text-white py-4 shadow-md">
    <div class="container mx-auto px-6 flex justify-center space-x-8">
      <a href="/mfksensor/" class="text-lg font-semibold hover:text-green-200 transition-colors">Kezdőlap</a>
      <a href="/mfksensor/map.html" class="text-lg font-semibold hover:text-green-200 transition-colors">Térkép</a>
      <a href="/mfksensor/analytics.html" class="text-lg font-semibold hover:text-green-200 transition-colors">Analitika</a>
    </div>
  </nav>
  <div class="container mx-auto p-6 flex-grow relative">
    <div class="mb-4 flex justify-center items-center gap-2">
      <label for="datePicker" class="text-md font-semibold text-gray-700">Válassz dátumot:</label>
      <input type="text" id="datePicker" class="border rounded px-2 py-1" placeholder="Dátum kiválasztása" />
    </div>
    <div id="loading" class="loading-overlay hidden">
      <div class="loading-spinner"></div>
      <span class="ml-4 text-lg font-semibold">Adatok betöltése...</span>
    </div>
    
    <div id="statsContainer" class="stats-container hidden">
      <h2 class="text-xl font-semibold mb-4 text-center">Levegőminőségi Statisztikák</h2>
      
      <div class="chart-wrapper">
        <div>
          <h3 class="text-center font-semibold text-gray-700">Délelőtti ingázás</h3>
          <div class="chart-controls">
            <label for="morning-y1">Bal Y:</label>
            <select id="morning-y1">
              <option value="pm2_5" selected>PM2.5</option>
              <option value="temperature">Hőmérséklet</option>
              <option value="humidity">Páratartalom</option>
              <option value="co2">CO₂</option>
            </select>
            <label for="morning-y2">Jobb Y:</label>
            <select id="morning-y2">
              <option value="pm2_5">PM2.5</option>
              <option value="temperature" selected>Hőmérséklet</option>
              <option value="humidity">Páratartalom</option>
              <option value="co2">CO₂</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="morningChart"></canvas>
          </div>
        </div>
        <div>
          <h3 class="text-center font-semibold text-gray-700">Délutáni ingázás</h3>
          <div class="chart-controls">
            <label for="afternoon-y1">Bal Y:</label>
            <select id="afternoon-y1">
              <option value="pm2_5" selected>PM2.5</option>
              <option value="temperature">Hőmérséklet</option>
              <option value="humidity">Páratartalom</option>
              <option value="co2">CO₂</option>
            </select>
            <label for="afternoon-y2">Jobb Y:</label>
            <select id="afternoon-y2">
              <option value="pm2_5">PM2.5</option>
              <option value="temperature" selected>Hőmérséklet</option>
              <option value="humidity">Páratartalom</option>
              <option value="co2">CO₂</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="afternoonChart"></canvas>
          </div>
        </div>
      </div>

      <table id="statsTable" class="stats-table">
        <thead>
          <tr>
            <th>Metrika</th>
            <th>Időszak</th>
            <th>Adatpont (N)</th>
            <th>Átlag</th>
            <th>Medián</th>
            <th>Min</th>
            <th>Max</th>
            <th>P95 Percentilis</th>
          </tr>
        </thead>
        <tbody id="statsBody"></tbody>
      </table>
      
    </div>
    <button id="exportButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-6 block mx-auto">Export CSV</button>
  </div>
  <footer class="bg-green-700 text-white text-center py-3 text-sm mt-auto">
    <p class="text-sm">© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium</p>
  </footer>
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script>
    let morningChartInstance = null;
    let afternoonChartInstance = null;
    let currentDayData = []; // ÚJ: Globális változó az adatok tárolására

    // ÚJ: Metrika adatok (címkék, színek)
    const metricsDetails = {
      'pm2_5': { label: 'PM2.5 (µg/m³)', color: 'rgb(234, 88, 12)' },
      'temperature': { label: 'Hőmérséklet (°C)', color: 'rgb(37, 99, 235)' },
      'humidity': { label: 'Páratartalom (%)', color: 'rgb(22, 163, 74)' },
      'co2': { label: 'CO₂ (ppm)', color: 'rgb(88, 28, 135)' }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseClient = supabase.createClient(
        'https://yuamroqhxrflusxeyylp.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NjA2ODgsImV4cCI6MjA2MTQzNjY4OH0.GOzgzWLxQnT6YzS8z2D4OKrsHkBnS55L7oRTMsEKs8U'
      );

      async function loadAvailableDates() {
        try {
          const { data, error } = await supabaseClient.rpc('get_distinct_dates');
          if (error) throw error;
          const dates = data.map(row => row.date).filter(Boolean);
          console.log('Elérhető dátumok:', dates);
          return dates;
        } catch (err) {
          console.error('Hiba a dátumok lekérdezésekor (get_distinct_dates):', err);
          return []; // Fontos: üres tömbbel térünk vissza hiba esetén
        }
      }

      // === MÓDOSÍTOTT calculateStats: getHours() ===
      function calculateStats(data) {
        // JAVÍTÁS: getHours() használata a getUTCHours() helyett a HELYI időzóna szerinti vágáshoz
        const morning = data.filter(item => new Date(item.timestamp).getHours() < 12);
        const afternoon = data.filter(item => new Date(item.timestamp).getHours() >= 12);

        // ... a többi statisztikai segédfüggvény (getMedian, getMin, stb.) változatlan ...
        const getMedian = arr => {
          if (!arr.length) return 0;
          const sorted = [...arr].sort((a, b) => a - b);
          const mid = Math.floor(sorted.length / 2);
          return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        };
        const getMin = arr => {
          if (!arr.length) return 0;
          return Math.min(...arr);
        };
        const getMax = arr => {
          if (!arr.length) return 0;
          return Math.max(...arr);
        };
        const getPercentile = (arr, p) => {
          if (!arr.length) return 0;
          const sorted = [...arr].sort((a, b) => a - b);
          const k = Math.ceil((p / 100) * sorted.length);
          return sorted[k > 0 ? k - 1 : 0];
        };
        const getAvg = arr => {
          if (!arr.length) return 0;
          return arr.reduce((a, b) => a + b, 0) / arr.length;
        };
        const createStatBlock = () => ({
          count: 0, avg: 0, median: 0, min: 0, max: 0, p95: 0
        });

        const stats = {
          pm25: { morning: createStatBlock(), afternoon: createStatBlock() },
          temp: { morning: createStatBlock(), afternoon: createStatBlock() },
          hum: { morning: createStatBlock(), afternoon: createStatBlock() },
          co2: { morning: createStatBlock(), afternoon: createStatBlock() }
        };

        const metricMap = {
          'pm2_5': 'pm25',
          'temperature': 'temp',
          'humidity': 'hum',
          'co2': 'co2'
        };

        for (const [metricKey, statKey] of Object.entries(metricMap)) {
          const morningValues = morning.map(item => item[metricKey]).filter(v => v != null && !isNaN(v));
          const afternoonValues = afternoon.map(item => item[metricKey]).filter(v => v != null && !isNaN(v));

          stats[statKey].morning = {
            count: morningValues.length,
            avg: getAvg(morningValues),
            median: getMedian(morningValues),
            min: getMin(morningValues),
            max: getMax(morningValues),
            p95: getPercentile(morningValues, 95)
          };
          stats[statKey].afternoon = {
            count: afternoonValues.length,
            avg: getAvg(afternoonValues),
            median: getMedian(afternoonValues),
            min: getMin(afternoonValues),
            max: getMax(afternoonValues),
            p95: getPercentile(afternoonValues, 95)
          };
        }
        
        return stats;
      }
      // === VÉGE: MÓDOSÍTOTT calculateStats ===


      async function fetchData(date) {
        const loading = document.getElementById('loading');
        loading.classList.remove('hidden');
        try {
          const start = `${date} 00:00:00+00`;
          const end = `${date} 23:59:59+00`;

          const { data, error } = await supabaseClient
            .from('air_quality_view')
            .select('id, timestamp, pm2_5, temperature, humidity, co2')
            .gte('timestamp', start)
            .lte('timestamp', end)
            .order('timestamp', { ascending: true });
            
          if (error) throw error;
          
          if (!data || data.length === 0) {
            console.warn('Nincs adat a megadott dátumra.');
            currentDayData = []; // Globális változó ürítése
            return []; 
          }
          
          console.log(`Lekérdezett adatok száma (${date}):`, data.length);
          currentDayData = data; // Globális változó feltöltése
          return data;
        } catch (err) {
          console.error('Hiba az adatok lekérdezésekor:', err);
          currentDayData = []; // Globális változó ürítése hiba esetén is
          return [];
        } finally {
          loading.classList.add('hidden');
        }
      }

      // === MÓDOSÍTOTT updateCharts: Dinamikus tengelyek + getHours() ===
      function updateCharts(data) {
        if (morningChartInstance) morningChartInstance.destroy();
        if (afternoonChartInstance) afternoonChartInstance.destroy();

        // JAVÍTÁS: getHours() használata a getUTCHours() helyett
        const morningData = data.filter(item => new Date(item.timestamp).getHours() < 12);
        const afternoonData = data.filter(item => new Date(item.timestamp).getHours() >= 12);

        // Dinamikus tengelyválasztók értékeinek kiolvasása
        const mY1 = document.getElementById('morning-y1').value;
        const mY2 = document.getElementById('morning-y2').value;
        const aY1 = document.getElementById('afternoon-y1').value;
        const aY2 = document.getElementById('afternoon-y2').value;

        const createChart = (canvasId, chartData, y1Key, y2Key) => {
          const ctx = document.getElementById(canvasId);
          if (!ctx || chartData.length === 0) return null;

          const y1Metric = metricsDetails[y1Key];
          const y2Metric = metricsDetails[y2Key];

          const labels = chartData.map(d => new Date(d.timestamp));
          const y1Data = chartData.map(d => d[y1Key]);
          const y2Data = chartData.map(d => d[y2Key]);

          return new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: y1Metric.label,
                  data: y1Data,
                  borderColor: y1Metric.color,
                  backgroundColor: y1Metric.color.replace(')', ', 0.5)'), // Szín áttetszővé tétele
                  yAxisID: 'y1',
                  tension: 0.1
                },
                {
                  label: y2Metric.label,
                  data: y2Data,
                  borderColor: y2Metric.color,
                  backgroundColor: y2Metric.color.replace(')', ', 0.5)'),
                  yAxisID: 'y2',
                  tension: 0.1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              scales: {
                x: {
                  type: 'time',
                  time: { unit: 'minute', tooltipFormat: 'HH:mm:ss', displayFormats: { minute: 'HH:mm' } },
                  title: { display: true, text: 'Időpont' }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: { display: true, text: y1Metric.label }
                },
                y2: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: { display: true, text: y2Metric.label },
                  grid: { drawOnChartArea: false },
                }
              }
            }
          });
        };

        morningChartInstance = createChart('morningChart', morningData, mY1, mY2);
        afternoonChartInstance = createChart('afternoonChart', afternoonData, aY1, aY2);
      }
      // === VÉGE: MÓDOSÍTOTT updateCharts ===

      // updateStats átnevezve updateStatsTable-re, hogy egyértelműbb legyen
      function updateStatsTable(data) {
        const statsContainer = document.getElementById('statsContainer');
        const statsBody = document.getElementById('statsBody');
        const stats = calculateStats(data); 

        statsBody.innerHTML = ''; 
        const metricDisplayNames = {
          pm25: 'PM2.5 (µg/m³)',
          temp: 'Hőmérséklet (°C)',
          hum: 'Páratartalom (%)',
          co2: 'CO₂ (ppm)'
        };

        for (const [metricKey, displayName] of Object.entries(metricDisplayNames)) {
          ['morning', 'afternoon'].forEach(period => {
            const periodName = period === 'morning' ? 'Délelőtt' : 'Délután';
            const statData = stats[metricKey][period];
            const row = document.createElement('tr');
            
            if (statData.count > 0) {
              row.innerHTML = `
                <td><strong>${displayName}</strong></td>
                <td>${periodName}</td>
                <td>${statData.count}</td>
                <td>${statData.avg.toFixed(1)}</td>
                <td>${statData.median.toFixed(1)}</td>
                <td>${statData.min.toFixed(1)}</td>
                <td>${statData.max.toFixed(1)}</td>
                <td>${statData.p95.toFixed(1)}</td>
              `;
            } else {
              row.classList.add('no-data');
              row.innerHTML = `
                <td><strong>${displayName}</strong></td>
                <td>${periodName}</td>
                <td>0</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>N/A</td>
              `;
            }
            statsBody.appendChild(row);
          });
        }
        statsContainer.classList.remove('hidden'); 
      }

      async function initializeAnalytics() {
        const validDates = await loadAvailableDates();
        const datePicker = document.getElementById('datePicker');
        
        flatpickr("#datePicker", {
          dateFormat: "Y-m-d",
          enable: validDates,
          defaultDate: validDates.length > 0 ? validDates[validDates.length - 1] : null,
          onChange: async (selectedDates) => {
            if (selectedDates.length > 0) {
              const date = selectedDates[0].toISOString().split('T')[0];
              document.getElementById('statsContainer').classList.add('hidden');
              const data = await fetchData(date); // Ez már feltölti a currentDayData-t
              updateCharts(data); // Diagram frissítése
              updateStatsTable(data); // Táblázat frissítése
            }
          }
        });

        if (validDates.length > 0) {
          const latestDate = validDates[validDates.length - 1];
          datePicker._flatpickr.setDate(latestDate);
          const data = await fetchData(latestDate); // Ez már feltölti a currentDayData-t
          updateCharts(data); // Diagram frissítése
          updateStatsTable(data); // Táblázat frissítése
        } else {
          console.warn("Nem töltődtek be elérhető dátumok. Az oldal üres marad.");
          updateCharts([]); // Üres diagramok
          updateStatsTable([]); // Üres táblázat
        }

        // === ÚJ: Eseményfigyelők a diagram választókra ===
        document.getElementById('morning-y1').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('morning-y2').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('afternoon-y1').addEventListener('change', () => updateCharts(currentDayData));
        document.getElementById('afternoon-y2').addEventListener('change', () => updateCharts(currentDayData));
        // ============================================
      }

      document.getElementById('exportButton').addEventListener('click', () => {
        // Az export logika változatlan
        console.log('Export gomb megnyomva');
        const datePicker = document.getElementById('datePicker');
        const selectedDate = datePicker.value;
        if (!selectedDate) {
          alert('Kérlek, válassz dátumot az exportáláshoz!');
          return;
        }

        // Újra lekérjük az adatot az exportáláshoz, hogy biztosan meglegyen
        fetchData(selectedDate).then(data => {
          if (data.length === 0) {
            alert('Nincs exportálható adat a kiválasztott dátumra!');
            return;
          }

          const csvRows = [];
          const headers = ['Dátum', 'Metrika', 'Időszak', 'Adatpont (N)', 'Átlag', 'Medián', 'Min', 'Max', 'P95 Percentilis'];
          csvRows.push(headers.join(','));

          const stats = calculateStats(data);
          const metricDisplayNames = {
            pm25: 'PM2.5 (µg/m³)',
            temp: 'Hőmérséklet (°C)',
            hum: 'Páratartalom (%)',
            co2: 'CO₂ (ppm)'
          };

          for (const [metricKey, displayName] of Object.entries(metricDisplayNames)) {
             ['morning', 'afternoon'].forEach(period => {
                const statData = stats[metricKey][period];
                if (statData.count > 0) {
                  const row = [
                    selectedDate, displayName,
                    period === 'morning' ? 'Délelőtt' : 'Délután',
                    statData.count,
                    statData.avg.toFixed(1),
                    statData.median.toFixed(1),
                    statData.min.toFixed(1),
                    statData.max.toFixed(1),
                    statData.p95.toFixed(1)
                  ].map(field => `"${field}"`).join(',');
                  csvRows.push(row);
                }
             });
          }
          
          if (csvRows.length <= 1) {
             alert('Nincs exportálható adat a kiválasztott dátumra!');
             return;
          }

          const csvContent = csvRows.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `air_quality_analytics_${selectedDate}.csv`;
          a.click();
          window.URL.revokeObjectURL(url);
        }).catch(err => {
          console.error('Hiba az exportálás során:', err);
          alert('Hiba az exportálás során!');
        });
      });

      initializeAnalytics();
    });
  </script>
</body>
</html>