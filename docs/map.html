document.addEventListener('DOMContentLoaded', async () => {
  try {
    console.log('Starting map initialization');
    
    // Ellenőrzések
    if (!document.getElementById('map')) {
      throw new Error('Map container not found');
    }
    if (typeof supabase === 'undefined') {
      throw new Error('Supabase JS library not loaded');
    }
    if (typeof maplibregl === 'undefined') {
      throw new Error('MapLibre GL library not loaded');
    }

    // Supabase inicializálás
    const supabaseClient = supabase.createClient(
      'https://yuamroqhxrflusxeyylp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAzODY2ODgsImV4cCI6MjA1NTk2MjY4OH0.5z3S3u9v2vX7Yc5eW1g0eN5eW1g0eN5eW1g0eN5eW1g0eN5eW1g'
    );
    console.log('Supabase client initialized');

    // Térkép inicializálása
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          osm: {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: '© OpenStreetMap contributors'
          }
        },
        layers: [{
          id: 'osm-tiles',
          type: 'raster',
          source: 'osm',
          minzoom: 0,
          maxzoom: 19
        }]
      },
      center: [20.362248, 47.898280],
      zoom: 12
    });
    console.log('Map initialized successfully');

    // Adatok lekérése
    console.log('Fetching air quality data...');
    const { data, error } = await supabaseClient
      .from('air_quality')
      .select('id, timestamp, pm2_5, temperature, humidity, co2, location')
      .not('location', 'is', null)
      .limit(1000);

    if (error) throw error;
    if (!data || data.length === 0) throw new Error('No data available');

    console.log(`Fetched ${data.length} records`);

    // GeoJSON létrehozása
    const geojson = {
      type: 'FeatureCollection',
      features: data.map(item => ({
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [item.location.lng, item.location.lat]
        },
        properties: {
          id: item.id,
          timestamp: item.timestamp,
          pm2_5: item.pm2_5,
          temperature: item.temperature,
          humidity: item.humidity,
          co2: item.co2
        }
      }))
    };

    // Térkép betöltése után
    map.on('load', () => {
      console.log('Adding air quality data to map...');
      
      // Forrás hozzáadása
      map.addSource('air_quality', {
        type: 'geojson',
        data: geojson
      });

      // Réteg hozzáadása
      map.addLayer({
        id: 'air_quality_points',
        type: 'circle',
        source: 'air_quality',
        paint: {
          'circle-radius': 8,
          'circle-color': [
            'interpolate',
            ['linear'],
            ['get', 'pm2_5'],
            0, '#00ff00',
            50, '#ff0000'
          ],
          'circle-opacity': 0.8
        }
      });

      // Popup kezelése
      map.on('click', 'air_quality_points', (e) => {
        const props = e.features[0].properties;
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <div class="p-2">
              <p><b>Idő:</b> ${new Date(props.timestamp).toLocaleString('hu-HU')}</p>
              <p><b>PM2.5:</b> ${props.pm2_5?.toFixed(2) || 'N/A'} µg/m³</p>
              <p><b>Hőmérséklet:</b> ${props.temperature?.toFixed(2) || 'N/A'}°C</p>
              <p><b>Páratartalom:</b> ${props.humidity?.toFixed(2) || 'N/A'}%</p>
              <p><b>CO₂:</b> ${props.co2 || 'N/A'} ppm</p>
            </div>
          `)
          .addTo(map);
      });

      // Kurzor változtatás
      map.on('mouseenter', 'air_quality_points', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'air_quality_points', () => {
        map.getCanvas().style.cursor = '';
      });
    });

    // Hibakezelés
    map.on('error', (e) => {
      console.error('Map error:', e.error);
    });

  } catch (error) {
    console.error('Error:', error);
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      mapContainer.innerHTML = `
        <div class="p-4 text-red-600">
          <p class="font-bold">Hiba történt:</p>
          <p>${error.message}</p>
          <p>Kérjük, próbáld újra később.</p>
        </div>
      `;
    }
  }
});
