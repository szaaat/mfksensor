<!-- 1. Nyelvválasztó a fejlécben -->
<header class="bg-green-700 text-white text-center py-6 shadow-lg relative">
  <div class="absolute top-4 right-4 flex space-x-2">
    <button id="lang-hu" class="lang-btn active" data-lang="hu">HU</button>
    <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
  </div>
  <h1 id="map-title" class="text-2xl md:text-3xl font-bold">ÉMNL 7B alprojekt – Mobil levegőminőségi szenzor térkép</h1>
  <nav class="mt-2">
    <a id="back-link" href="/mfksensor/" class="underline text-sm hover:text-green-300">← Vissza a kezdőlapra</a>
  </nav>
</header>

<!-- 2. Dátumválasztó és export gomb frissítése -->
<div class="mb-4 flex justify-center items-center gap-2">
  <label id="date-label" for="datePicker" class="text-md font-semibold text-gray-700">Válassz dátumot:</label>
  <input type="text" id="datePicker" class="border rounded px-2 py-1" placeholder="Dátum kiválasztása" />
  <button id="exportButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded ml-2">Export CSV</button>
</div>

<!-- 3. Jelmagyarázat frissítése -->
<div id="legend" class="legend hidden bg-white bg-opacity-90 p-3 rounded-lg shadow-md">
  <h3 id="legend-title" class="font-bold mb-2 text-sm">Levegőminőség (PM2.5)</h3>
  <!-- ... meglévő tartalom ... -->
</div>

<!-- 4. Figyelmeztetés frissítése -->
<p id="map-disclaimer" class="text-sm text-red-600 text-center mt-2 font-semibold">
  ⚠️ A mérési adatok nem hitelesítettek – tájékoztató jellegűek!
</p>

<!-- 5. Lábléc frissítése -->
<footer class="bg-green-700 text-white text-center py-3 text-sm mt-auto">
  <p id="map-footer">© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium</p>
</footer>

<!-- 6. Script rész bővítése -->
<script>
  // Nyelvi beállítások a térkép oldalhoz
  const mapTranslations = {
    hu: {
      title: "ÉMNL 7B alprojekt – Mobil levegőminőségi szenzor térkép",
      back: "← Vissza a kezdőlapra",
      dateLabel: "Válassz dátumot:",
      export: "Export CSV",
      disclaimer: "⚠️ A mérési adatok nem hitelesítettek – tájékoztató jellegűek!",
      footer: "© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium",
      legendTitle: "Levegőminőség (PM2.5)",
      legendItems: [
        "0–10 µg/m³ (JÓ)",
        "10.1–20 µg/m³ (MEGFELELŐ)",
        "20.1–25 µg/m³ (ELFOGADHATÓ)",
        "25.1–50 µg/m³ (SZENNYEZETT)",
        "50.1–75 µg/m³ (ERŐSEN SZENNYEZETT)",
        "75+ µg/m³ (EXTRÉM SZENNYEZETT)"
      ],
      popupTitle: "Mérési adatok",
      popupTime: "Időpont:",
      popupPM1: "PM1.0:",
      popupPM25: "PM2.5:",
      popupPM4: "PM4.0:",
      popupPM10: "PM10:",
      popupTemp: "Hőmérséklet:",
      popupHumidity: "Páratartalom:",
      popupVOC: "VOC:",
      popupNOx: "NOx:",
      popupCO2: "CO₂:"
    },
    en: {
      title: "NMLC 7B Subproject - Mobile Air Quality Sensor Map",
      back: "← Back to home",
      dateLabel: "Select date:",
      export: "Export CSV",
      disclaimer: "⚠️ Measurement data is not verified - for informational purposes only!",
      footer: "© Climate Change Multidisciplinary National Laboratory",
      legendTitle: "Air Quality (PM2.5)",
      legendItems: [
        "0–10 µg/m³ (GOOD)",
        "10.1–20 µg/m³ (MODERATE)",
        "20.1–25 µg/m³ (ACCEPTABLE)",
        "25.1–50 µg/m³ (POOR)",
        "50.1–75 µg/m³ (VERY POOR)",
        "75+ µg/m³ (EXTREME)"
      ],
      popupTitle: "Measurement Data",
      popupTime: "Time:",
      popupPM1: "PM1.0:",
      popupPM25: "PM2.5:",
      popupPM4: "PM4.0:",
      popupPM10: "PM10:",
      popupTemp: "Temperature:",
      popupHumidity: "Humidity:",
      popupVOC: "VOC:",
      popupNOx: "NOx:",
      popupCO2: "CO₂:"
    }
  };

  // Nyelv beállítása és frissítés
  function setMapLanguage(lang) {
    localStorage.setItem('language', lang);
    applyMapLanguage(lang);
  }

  function applyMapLanguage(lang) {
    const langData = mapTranslations[lang];
    
    // Frissítjük az oldal elemeit
    document.getElementById('map-title').textContent = langData.title;
    document.getElementById('back-link').textContent = langData.back;
    document.getElementById('date-label').textContent = langData.dateLabel;
    document.getElementById('exportButton').textContent = langData.export;
    document.getElementById('map-disclaimer').textContent = langData.disclaimer;
    document.getElementById('map-footer').textContent = langData.footer;
    document.getElementById('legend-title').textContent = langData.legendTitle;
    
    // Jelmagyarázat elemek frissítése
    const legendItems = document.querySelectorAll('.legend-item');
    legendItems.forEach((item, index) => {
      if (langData.legendItems[index]) {
        item.textContent = langData.legendItems[index];
      }
    });
    
    // Popup tartalmának frissítése (ha meg van nyitva)
    if (window.currentPopup) {
      window.currentPopup.remove();
    }
    
    // Gombok aktív állapotának beállítása
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === lang);
    });
  }

  // Oldal betöltésekor
  document.addEventListener('DOMContentLoaded', () => {
    // Alapértelmezett nyelv beállítása
    const savedLang = localStorage.getItem('language') || 'hu';
    setMapLanguage(savedLang);

    // Nyelvválasztó gombok eseménykezelői
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setMapLanguage(btn.dataset.lang);
      });
    });

    // Popup tartalmának lokalizációja
    const originalPopupHandler = map.on('click', 'air_quality_points', e => {
      // ... eredeti kód ...
    });
    
    // Felülírjuk a popup kezelőt, hogy a kiválasztott nyelven jelenjen meg
    map.off('click', 'air_quality_points', originalPopupHandler);
    map.on('click', 'air_quality_points', e => {
      const lang = localStorage.getItem('language') || 'hu';
      const langData = mapTranslations[lang];
      const p = e.features[0].properties;
      
      // Dátum formázás a nyelvnek megfelelően
      const options = lang === 'hu' ? {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      } : {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      };
      
      const ts = p.timestamp ? new Date(p.timestamp).toLocaleString(lang === 'hu' ? 'hu-HU' : 'en-GB', options) : 'N/A';
      
      window.currentPopup = new maplibregl.Popup({ className: 'custom-popup', maxWidth: '300px' })
        .setLngLat(e.lngLat)
        .setHTML(`
          <div class="popup-content">
            <h3 class="font-bold text-lg mb-2 text-blue-700">${langData.popupTitle}</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div><strong>${langData.popupTime}</strong></div>
              <div>${ts}</div>
              <div><strong>${langData.popupPM1}</strong></div>
              <div>${p.pm1_0?.toFixed(1) || '–'} µg/m³</div>
              <div><strong>${langData.popupPM25}</strong></div>
              <div>${p.pm2_5?.toFixed(1) || '–'} µg/m³</div>
              <div><strong>${langData.popupPM4}</strong></div>
              <div>${p.pm4_0?.toFixed(1) || '–'} µg/m³</div>
              <div><strong>${langData.popupPM10}</strong></div>
              <div>${p.pm10_0?.toFixed(1) || '–'} µg/m³</div>
              <div><strong>${langData.popupTemp}</strong></div>
              <div>${p.temperature?.toFixed(1) || '–'} °C</div>
              <div><strong>${langData.popupHumidity}</strong></div>
              <div>${p.humidity?.toFixed(1) || '–'} %</div>
              <div><strong>${langData.popupVOC}</strong></div>
              <div>${p.voc || '–'} index</div>
              <div><strong>${langData.popupNOx}</strong></div>
              <div>${p.nox || '–'} index</div>
              <div><strong>${langData.popupCO2}</strong></div>
              <div>${p.co2 || '–'} ppm</div>
            </div>
          </div>
        `)
        .addTo(map);
    });
  });
</script>