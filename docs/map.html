<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Levegőminőségi Térkép</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.tailwindcss.com/3.4.0"></script>
  <style>
    #map { height: calc(100vh - 220px); }
    .loading-overlay {
      position: absolute; inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      flex-direction: column;
      z-index: 1000;
    }
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .legend {
      position: absolute;
      bottom: 30px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      max-width: 200px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
      font-size: 11px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 5px;
      border-radius: 50%;
      border: 1px solid #666;
    }
    /* Háttér információs doboz */
    .background-info {
        position: absolute;
        bottom: 260px;
        left: 10px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #ddd;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
        width: 200px;
    }
    .custom-popup {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .custom-popup .maplibregl-popup-content {
      padding: 12px;
      border-radius: 6px;
    }
    .custom-popup .maplibregl-popup-tip {
      border-top-color: rgba(255,255,255,0.9);
    }
    .lang-btn {
      padding: 2px 10px;
      border: 1px solid white;
      border-radius: 4px;
      background: transparent;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }
    .lang-btn.active {
      background: white;
      color: green;
      font-weight: bold;
    }
    .lang-btn:hover:not(.active) {
      background: rgba(255,255,255,0.2);
    }
    @media (max-width: 768px) {
      #map { height: calc(100vh - 180px); }
      .legend, .background-info {
        left: 5px;
        padding: 5px;
        font-size: 10px;
        width: 150px;
      }
      .legend { bottom: 20px; }
      .background-info { bottom: 200px; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 font-sans min-h-screen flex flex-col">
  <header class="bg-green-700 text-white text-center py-6 shadow-lg relative">
    <div class="absolute top-4 right-4 flex space-x-2">
      <button id="lang-hu" class="lang-btn active" data-lang="hu">HU</button>
      <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
    </div>
    <h1 id="map-title" class="text-2xl md:text-3xl font-bold">ÉMNL 7B alprojekt – Mobil levegőminőségi szenzor térkép</h1>
    <nav class="mt-2">
      <a id="back-link" href="/mfksensor/" class="underline text-sm hover:text-green-300">← Vissza a kezdőlapra</a>
    </nav>
  </header>
  <main class="container mx-auto p-4 flex-grow relative">
    <div class="mb-4 flex flex-wrap justify-center items-center gap-2">
      <label id="date-label" for="datePicker" class="text-md font-semibold text-gray-700">Válassz dátumot:</label>
      <input type="text" id="datePicker" class="border rounded px-2 py-1 w-32" placeholder="Dátum..." />
      
      <label id="metric-label" for="metricSelect" class="text-md font-semibold text-gray-700 ml-4">Adat:</label>
      <select id="metricSelect" class="border rounded px-2 py-1 bg-white">
          <option value="pm2_5">PM2.5</option>
          <option value="pm25_diff">PM2.5 Különbség</option>
          <option value="pm25_bg">PM2.5 Háttér</option>
          <option value="co2">CO₂</option>
          <option value="co2_diff">CO₂ Különbség</option>
          <option value="co2_bg">CO₂ Háttér</option>
          <option value="temperature">Hőmérséklet</option>
          <option value="humidity">Páratartalom</option>
          <option value="voc">VOC Index</option>
          <option value="nox">NOx Index</option>
          <option value="altitude">Magasság</option>
      </select>

      <button id="exportButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded ml-2">Export CSV</button>
    </div>
    
    <div id="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <span id="loading-text" class="ml-4 text-lg font-semibold">Adatok betöltése...</span>
    </div>
    
    <div id="map" class="rounded-xl shadow-lg border border-gray-300"></div>
    
    <div id="background-info" class="background-info hidden">
        <h3 class="font-bold mb-2 text-blue-700 border-b pb-1">Napi Háttér (PM2.5)</h3>
        <div class="grid grid-cols-2 gap-1">
            <span class="font-semibold">Délelőtt:</span>
            <span id="bg-morning" class="text-right text-green-600 font-bold">-</span>
            <span class="font-semibold">Délután:</span>
            <span id="bg-afternoon" class="text-right text-green-600 font-bold">-</span>
        </div>
    </div>

    <div id="legend" class="legend hidden bg-white bg-opacity-90 p-3 rounded-lg shadow-md">
      <h3 id="legend-title" class="font-bold mb-2 text-sm">Jelmagyarázat</h3>
      <div id="legend-content"></div>
    </div>
    
    <p id="map-disclaimer" class="text-sm text-red-600 text-center mt-2 font-semibold">
      ⚠️ A mérési adatok nem hitelesítettek – tájékoztató jellegűek!
    </p>
  </main>
  <footer class="bg-green-700 text-white text-center py-3 text-sm mt-auto">
    <p id="map-footer">© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium</p>
  </footer>
  
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/hu.js"></script>
  
  <script>
    const supabaseClient = supabase.createClient(
      'https://yuamroqhxrflusxeyylp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YW1yb3FoeHJmbHVzeGV5eWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NjA2ODgsImV4cCI6MjA2MTQzNjY4OH0.GOzgzWLxQnT6YzS8z2D4OKrsHkBnS55L7oRTMsEKs8U'
    );

    let geojsonData = null;
    let fpInstance = null;
    let currentMetric = 'pm2_5';

    // --- IDŐZÓNA JAVÍTÁS ---
    function formatDateToLocal(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleString('hu-HU', {
            timeZone: 'Europe/Budapest',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // --- METRIKA KONFIG ---
    const METRIC_CONFIG = {
        'pm2_5': {
            label: 'PM2.5 (µg/m³)',
            stops: [0, 10, 20, 25, 50, 75],
            colors: ['#00E400', '#66FF33', '#FFFF00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Jó', 'Megfelelő', 'Elfogadható', 'Szennyezett', 'Erősen szenn.', 'Extrém']
        },
        'pm25_bg': {
            label: 'PM2.5 Háttér (µg/m³)',
            stops: [0, 10, 20, 25, 50, 75],
            colors: ['#00E400', '#66FF33', '#FFFF00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Jó', 'Megfelelő', 'Elfogadható', 'Szennyezett', 'Erősen szenn.', 'Extrém']
        },
        'pm25_diff': {
            label: 'PM2.5 Különbség (µg/m³)',
            stops: [0, 2, 5, 10, 20, 50],
            colors: ['#FFFFFF', '#FFFF00', '#FFCC00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Semmi', 'Kicsi', 'Közepes', 'Magas', 'Nagyon Magas', 'Extrém']
        },
        'co2': {
            label: 'CO₂ (ppm)',
            stops: [400, 600, 800, 1000, 1500, 2000],
            colors: ['#00E400', '#66FF33', '#FFFF00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Friss', 'Jó', 'Közepes', 'Rossz', 'Nagyon Rossz', 'Veszélyes']
        },
        'co2_bg': {
            label: 'CO₂ Háttér (ppm)',
            stops: [400, 500, 600, 800, 1000, 1200],
            colors: ['#00E400', '#66FF33', '#FFFF00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Friss', 'Jó', 'Közepes', 'Rossz', 'Nagyon Rossz', 'Veszélyes']
        },
        'co2_diff': {
            label: 'CO₂ Különbség (ppm)',
            stops: [0, 50, 100, 200, 400, 800],
            colors: ['#FFFFFF', '#FFFF00', '#FFCC00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Semmi', 'Kicsi', 'Közepes', 'Magas', 'Nagyon Magas', 'Extrém']
        },
        'temperature': {
            label: 'Hőmérséklet (°C)',
            stops: [0, 10, 20, 25, 30, 35],
            colors: ['#0000FF', '#00FFFF', '#00FF00', '#FFFF00', '#FF9900', '#FF0000'],
            labels: ['Hideg', 'Hűvös', 'Kellemes', 'Meleg', 'Forró', 'Hőség']
        },
        'humidity': {
            label: 'Páratartalom (%)',
            stops: [0, 20, 40, 60, 80, 100],
            colors: ['#FF0000', '#FF9900', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF'],
            labels: ['Száraz', 'Alacsony', 'Ideális', 'Magas', 'Nagyon magas', 'Telített']
        },
        'altitude': {
            label: 'Magasság (m)',
            stops: [100, 200, 300, 500, 800, 1000],
            colors: ['#006400', '#228B22', '#32CD32', '#FFFF00', '#FFA500', '#8B4513'],
            labels: ['Alföld', 'Domb', 'Domb', 'Hegy', 'Hegy', 'Csúcs']
        },
        'voc': {
            label: 'VOC Index',
            stops: [0, 50, 100, 150, 200, 300],
            colors: ['#00E400', '#66FF33', '#FFFF00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Tiszta', 'Jó', 'Közepes', 'Rossz', 'Nagyon Rossz', 'Veszélyes']
        },
        'nox': {
            label: 'NOx Index',
            stops: [0, 1, 2, 3, 4, 5],
            colors: ['#00E400', '#66FF33', '#FFFF00', '#FF9900', '#FF0000', '#660033'],
            labels: ['Tiszta', 'Jó', 'Közepes', 'Rossz', 'Nagyon Rossz', 'Veszélyes']
        }
    };

    const mapTranslations = {
      hu: {
        title: "ÉMNL 7B alprojekt – Mobil levegőminőségi szenzor térkép",
        back: "← Vissza a kezdőlapra",
        dateLabel: "Válassz dátumot:",
        metricLabel: "Adat:",
        export: "Export CSV",
        loading: "Adatok betöltése...",
        disclaimer: "⚠️ A mérési adatok nem hitelesítettek – tájékoztató jellegűek!",
        footer: "© Éghajlatváltozás Multidiszciplináris Nemzeti Laboratórium",
        popupTitle: "Mérési adatok",
        popupTime: "Időpont:",
        exportHeaders: ['ID', 'Idő', 'Hosszúság', 'Szélesség', 'PM1.0', 'PM2.5', 'PM2.5 Háttér', 'PM2.5 Diff', 'PM4.0', 'PM10', 'Hőmérséklet', 'Páratartalom', 'VOC', 'NOx', 'CO₂', 'CO₂ Háttér', 'CO₂ Diff', 'Magasság', 'Szélseb.', 'Szélirány']
      },
      en: {
        title: "Mobile Air Quality Sensor Map",
        back: "← Back to home",
        dateLabel: "Select date:",
        metricLabel: "Metric:",
        export: "Export CSV",
        loading: "Loading data...",
        disclaimer: "⚠️ Measurement data is not verified – for informational purposes only!",
        footer: "© Climate Change Multidisciplinary National Laboratory",
        popupTitle: "Measurement Data",
        popupTime: "Time:",
        exportHeaders: ['ID', 'Time', 'Longitude', 'Latitude', 'PM1.0', 'PM2.5', 'PM2.5 BG', 'PM2.5 Diff', 'PM4.0', 'PM10', 'Temperature', 'Humidity', 'VOC', 'NOx', 'CO₂', 'CO₂ BG', 'CO₂ Diff', 'Altitude', 'Wind Speed', 'Wind Dir']
      }
    };

    function setMapLanguage(lang) {
      localStorage.setItem('language', lang);
      applyMapLanguage(lang);
      if (fpInstance) {
        const newLocale = (lang === 'hu') ? 'hu' : 'default';
        fpInstance.set('locale', newLocale);
      }
      // Opciók frissítése
      document.querySelector('option[value="pm25_diff"]').textContent = lang === 'hu' ? 'PM2.5 Különbség' : 'PM2.5 Diff';
      document.querySelector('option[value="co2_diff"]').textContent = lang === 'hu' ? 'CO₂ Különbség' : 'CO₂ Diff';
      document.querySelector('option[value="temperature"]').textContent = lang === 'hu' ? 'Hőmérséklet' : 'Temperature';
      document.querySelector('option[value="humidity"]').textContent = lang === 'hu' ? 'Páratartalom' : 'Humidity';
      document.querySelector('option[value="altitude"]').textContent = lang === 'hu' ? 'Magasság' : 'Altitude';
    }

    function applyMapLanguage(lang) {
      const langData = mapTranslations[lang];
      document.getElementById('map-title').textContent = langData.title;
      document.getElementById('back-link').textContent = langData.back;
      document.getElementById('date-label').textContent = langData.dateLabel;
      document.getElementById('metric-label').textContent = langData.metricLabel;
      document.getElementById('exportButton').textContent = langData.export;
      document.getElementById('loading-text').textContent = langData.loading;
      document.getElementById('map-disclaimer').textContent = langData.disclaimer;
      document.getElementById('map-footer').textContent = langData.footer;
      document.title = langData.title;
      
      document.documentElement.lang = lang;
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      updateLegend();
    }

    const getCoordinates = (location) => {
      if (!location) return null;
      if (typeof location === 'string') {
        try { location = JSON.parse(location); } catch (e) { return null; }
      }
      if (location?.type === 'Point' && Array.isArray(location.coordinates) && location.coordinates.length >= 2) {
        return { lng: +location.coordinates[0], lat: +location.coordinates[1] };
      }
      return null;
    };

    // --- JAVÍTVA: VISSZA A RÉGI RPC-HEZ ---
    async function loadAvailableDates() {
      try {
        const { data, error } = await supabaseClient.rpc('get_distinct_dates');

        if (error) throw error;
        
        // Ha az RPC objektumokat ad (pl. [{date: "2023-01-01"}]), kinyerjük a dátumot
        if (data && data.length > 0 && data[0].date) {
             return data.map(item => item.date);
        }
        // Ha sima stringeket ad, akkor jó így
        return data || [];
      } catch (err) {
        console.error('Hiba a dátumoknál:', err);
        // Fallback: üres lista (a "ma" logika úgyis hozzáadja a mai napot)
        return [];
      }
    }

    function updateBackgroundInfo(data) {
        const bgInfo = document.getElementById('background-info');
        const bgMorning = document.getElementById('bg-morning');
        const bgAfternoon = document.getElementById('bg-afternoon');
        
        if (!data || data.length === 0) {
            bgInfo.classList.add('hidden');
            return;
        }

        let morningVal = null;
        let afternoonVal = null;

        for (const row of data) {
            if (!row.timestamp) continue;
            const hour = new Date(row.timestamp).getHours();
            
            if (typeof row.pm25_bg === 'number') {
                if (hour < 12 && morningVal === null) morningVal = row.pm25_bg;
                if (hour >= 12 && afternoonVal === null) afternoonVal = row.pm25_bg;
            }
            if (morningVal !== null && afternoonVal !== null) break;
        }

        const formatVal = (val) => (typeof val === 'number') ? `${val.toFixed(1)} µg/m³` : '-';
        bgMorning.textContent = formatVal(morningVal);
        bgAfternoon.textContent = formatVal(afternoonVal);
        
        bgInfo.classList.remove('hidden');
    }

    function updateLegend() {
        const config = METRIC_CONFIG[currentMetric];
        const legendContent = document.getElementById('legend-content');
        const legendTitle = document.getElementById('legend-title');
        
        legendTitle.textContent = config.label;
        legendContent.innerHTML = '';

        for (let i = 0; i < config.stops.length; i++) {
            const color = config.colors[i];
            const label = config.labels ? config.labels[i] : `${config.stops[i]}+`;
            const range = i < config.stops.length - 1 
                ? `${config.stops[i]} – ${config.stops[i+1]}` 
                : `${config.stops[i]}+`;
            
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<div class="legend-color" style="background-color: ${color};"></div><span class="legend-text">${range} (${label})</span>`;
            legendContent.appendChild(item);
        }
    }

    async function fetchAirQualityData(date) {
      const loading = document.getElementById('loading');
      loading.style.display = 'flex';
      try {
        const start = `${date} 00:00:00+00`;
        const end = `${date} 23:59:59+00`;

        let allData = [];
        let offset = 0;
        const batchSize = 10000;

        const { count, error: countError } = await supabaseClient
          .from('air_quality_view')
          .select('*', { count: 'exact', head: true })
          .gte('timestamp', start)
          .lte('timestamp', end);
        
        if (countError) throw countError;

        while (offset < count) {
          const { data, error } = await supabaseClient
            .from('air_quality_view')
            .select('*')
            .gte('timestamp', start)
            .lte('timestamp', end)
            .order('timestamp', { ascending: true })
            .range(offset, offset + batchSize - 1);
            
          if (error) throw error;
          if (!data || data.length === 0) break;
          
          allData = allData.concat(data);
          offset += data.length;
        }

        updateBackgroundInfo(allData);

        const features = allData.map(row => {
          const coords = getCoordinates(row.location);
          if (!coords) return null;
          return {
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [coords.lng, coords.lat] },
            properties: { ...row, location: undefined }
          };
        }).filter(Boolean);

        geojsonData = { type: 'FeatureCollection', features };
        return geojsonData;
      } catch (err) {
        console.error('Hiba:', err);
        return { type: 'FeatureCollection', features: [] };
      } finally {
        loading.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loading = document.getElementById('loading');
      let savedLang = 'hu';

      try {
        savedLang = localStorage.getItem('language') || 'hu';
        setMapLanguage(savedLang);

        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            setMapLanguage(btn.dataset.lang);
          });
        });

        const metricSelect = document.getElementById('metricSelect');
        metricSelect.addEventListener('change', (e) => {
            currentMetric = e.target.value;
            updateLegend();
            updateMapPaintProperties();
        });

        const map = new maplibregl.Map({
          container: 'map',
          style: {
            version: 8,
            sources: {
              osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256, attribution: '© OpenStreetMap' }
            },
            layers: [{ id: 'osm-tiles', type: 'raster', source: 'osm', minzoom: 0, maxzoom: 22 }]
          },
          center: [20.36, 47.89],
          zoom: 8
        });

        map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'top-right');
        map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: 'metric' }));

        const datePicker = document.getElementById('datePicker');
        
        // --- JAVÍTOTT LOGIKA: MAI NAP MINDIG ELÉRHETŐ ---
        const validDates = await loadAvailableDates();
        const today = new Date().toISOString().split('T')[0];
        
        // Ha a mai nap nincs a listában, hozzáadjuk a VÉGÉRE
        if (!validDates.includes(today)) {
            validDates.push(today);
        }

        // Alapértelmezett dátum a lista legvége (ami vagy az utolsó adat, vagy a mai nap)
        const latestDate = validDates[validDates.length - 1];

        fpInstance = flatpickr("#datePicker", {
          dateFormat: "Y-m-d",
          enable: validDates,
          defaultDate: latestDate, // Mindig a legfrissebb (mai) dátumot választja
          onChange: () => updateMapData(),
          locale: savedLang
        });

        function updateMapPaintProperties() {
            if (!map.getLayer('air_quality_points')) return;

            const config = METRIC_CONFIG[currentMetric];
            const colorExpression = ['interpolate', ['linear'], ['get', currentMetric]];
            
            for (let i = 0; i < config.stops.length; i++) {
                colorExpression.push(config.stops[i]);
                colorExpression.push(config.colors[i]);
            }

            map.setPaintProperty('air_quality_points', 'circle-color', colorExpression);
        }

        async function updateMapData() {
          const geojson = await fetchAirQualityData(datePicker.value);
          
          if (map.getSource('air_quality')) {
            map.getSource('air_quality').setData(geojson);
          } else {
            map.addSource('air_quality', {
              type: 'geojson',
              data: geojson,
              cluster: false
            });
            
            map.addLayer({
              id: 'air_quality_points',
              type: 'circle',
              source: 'air_quality',
              paint: {
                'circle-radius': ['interpolate', ['linear'], ['zoom'], 10, 4, 15, 8],
                'circle-opacity': 0.8,
                'circle-stroke-width': 1,
                'circle-stroke-color': '#fff'
              }
            });

            updateMapPaintProperties();

            map.on('click', 'air_quality_points', async e => {
                const lang = localStorage.getItem('language') || 'hu';
                const langData = mapTranslations[lang];
                const props = e.features[0].properties;
                const coordinates = e.features[0].geometry.coordinates.slice();

                new maplibregl.Popup({ className: 'custom-popup', maxWidth: '300px' })
                  .setLngLat(coordinates)
                  .setHTML(`
                    <div class="popup-content">
                      <h3 class="font-bold text-lg mb-2 text-blue-700">${langData.popupTitle}</h3>
                      <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><strong>${langData.popupTime}</strong></div>
                        <div>${formatDateToLocal(props.timestamp)}</div>
                        
                        <div><strong>PM2.5:</strong></div><div>${props.pm2_5?.toFixed(1) || '-'} µg/m³</div>
                        <div><strong>PM2.5 Diff:</strong></div><div>${props.pm25_diff?.toFixed(1) || '-'}</div>
                        <div><strong>PM2.5 Háttér:</strong></div><div>${props.pm25_bg?.toFixed(1) || '-'}</div>
                        <div><strong>CO₂:</strong></div><div>${props.co2?.toFixed(0) || '-'} ppm</div>
                        <div><strong>CO₂ Diff:</strong></div><div>${props.co2_diff?.toFixed(0) || '-'}</div>
                        
                        <div><strong>Hőmérséklet:</strong></div><div>${props.temperature?.toFixed(1) || '-'} °C</div>
                        <div><strong>Páratartalom:</strong></div><div>${props.humidity?.toFixed(1) || '-'} %</div>
                        
                        <div><strong>Magasság:</strong></div><div>${props.altitude?.toFixed(0) || '-'} m</div>
                        <div><strong>Szél:</strong></div><div>${props.wind_speed_10m?.toFixed(1) || '-'} km/h</div>
                      </div>
                    </div>
                  `)
                  .addTo(map);
            });
          }
          
          updateMapPaintProperties();
          
          const bounds = new maplibregl.LngLatBounds();
          geojson.features.forEach(f => bounds.extend(f.geometry.coordinates));
          if (!bounds.isEmpty()) {
            map.fitBounds(bounds, { padding: 40, maxZoom: 14 });
          }
        }

        if (latestDate) {
          updateMapData();
        }

        // EXPORT FUNKCIÓ
        document.getElementById('exportButton').addEventListener('click', async () => {
          const lang = localStorage.getItem('language') || 'hu';
          const langData = mapTranslations[lang];
          const date = datePicker.value;
          if (!date) return;

          const exportButton = document.getElementById('exportButton');
          exportButton.disabled = true;
          exportButton.textContent = "Export...";

          try {
            const start = `${date} 00:00:00+00`;
            const end = `${date} 23:59:59+00`;
            
            let allData = [];
            let offset = 0;
            const batchSize = 10000;
            const { count } = await supabaseClient.from('air_quality_view').select('*', { count: 'exact', head: true }).gte('timestamp', start).lte('timestamp', end);

            while (offset < count) {
                const { data } = await supabaseClient.from('air_quality_view').select('*').gte('timestamp', start).lte('timestamp', end).range(offset, offset + batchSize - 1);
                if (!data) break;
                allData = allData.concat(data);
                offset += data.length;
            }

            const csvRows = [];
            csvRows.push(langData.exportHeaders.join(','));

            allData.forEach(p => {
              const coords = getCoordinates(p.location);
              const row = [
                p.id || '',
                formatDateToLocal(p.timestamp),
                coords ? coords.lng.toFixed(6) : '',
                coords ? coords.lat.toFixed(6) : '',
                p.pm1_0 || '',
                p.pm2_5 || '',
                p.pm25_bg || '',
                p.pm25_diff || '',
                p.pm4_0 || '',
                p.pm10_0 || '',
                p.temperature || '',
                p.humidity || '',
                p.voc || '',
                p.nox || '',
                p.co2 || '',
                p.co2_bg || '',
                p.co2_diff || '',
                p.altitude || '',
                p.wind_speed_10m || '',
                p.wind_direction_10m || ''
              ].map(f => `"${f}"`).join(',');
              csvRows.push(row);
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `air_quality_${date}.csv`;
            a.click();
          } catch (e) {
              alert("Hiba az exportálásnál: " + e.message);
          } finally {
              exportButton.disabled = false;
              exportButton.textContent = langData.export;
          }
        });

      } catch (err) {
        console.error('Hiba:', err);
        if (loadingText) loadingText.textContent = "Hiba történt az oldal betöltésekor.";
      }
    });
  </script>
</body>
</html>